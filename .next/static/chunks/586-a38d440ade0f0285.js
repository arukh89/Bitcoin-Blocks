"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[586],{85:(e,t,r)=>{r.d(t,{LC:()=>o});var n=r(42094),s=r(32841);class a{static getInstance(){return a.instance||(a.instance=new a),a.instance}startTimer(e,t){this.entries.set(e,{name:e,startTime:performance.now(),metadata:t})}endTimer(e,t){let r=this.entries.get(e);if(!r)return console.warn("Timer '".concat(e,"' was not started")),null;let n=performance.now()-r.startTime;return this.recordMetric({name:"".concat(e,"_duration"),value:Math.round(n),unit:"ms",timestamp:Date.now(),tags:{...r.metadata,...t}}),this.entries.delete(e),n}recordMetric(e){this.metrics.push(e),this.metrics.length>1e3&&(this.metrics=this.metrics.slice(-1e3)),e.value>("ms"===e.unit?1e3:"percent"===e.unit?90:1e6)&&(0,s.ow)("High ".concat(e.name," detected"),{action:"performance_alert",additionalData:{metric:e.name,value:e.value,unit:e.unit,tags:e.tags}},Error("Performance threshold exceeded: ".concat(e.name," = ").concat(e.value).concat(e.unit)))}async measureFunction(e,t,r){this.startTimer(e,r);try{let n=await t();return this.endTimer(e,{...r,success:"true"}),n}catch(t){throw this.endTimer(e,{...r,success:"false",error:t.message}),t}}getMetrics(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,r=this.metrics;return e&&(r=r.filter(t=>t.name===e)),r.sort((e,t)=>t.timestamp-e.timestamp).slice(0,t)}getMetricStats(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:36e5,r=Date.now(),n=this.metrics.filter(n=>n.name===e&&n.timestamp>r-t);if(0===n.length)return null;let s=n.map(e=>e.value).sort((e,t)=>e-t),a=s.length,o=s[0],i=s[a-1],c=s.reduce((e,t)=>e+t,0)/a,u=s[Math.floor(.5*a)],l=s[Math.floor(.95*a)],d=s[Math.floor(.99*a)];return{count:a,min:o,max:i,avg:c,p50:u,p95:l,p99:d}}initializeObservers(){try{let e=new PerformanceObserver(e=>{for(let t of e.getEntries())"navigation"===t.entryType&&(this.recordMetric({name:"page_load_time",value:Math.round(t.loadEventEnd-t.loadEventStart),unit:"ms",timestamp:Date.now()}),this.recordMetric({name:"dom_content_loaded",value:Math.round(t.domContentLoadedEventEnd-t.domContentLoadedEventStart),unit:"ms",timestamp:Date.now()}))});e.observe({entryTypes:["navigation"]}),this.observers.push(e)}catch(e){console.warn("Failed to initialize navigation observer:",e)}try{let e=new PerformanceObserver(e=>{for(let r of e.getEntries())if("resource"===r.entryType){var t;this.recordMetric({name:"resource_load_time",value:Math.round(r.responseEnd-r.requestStart),unit:"ms",timestamp:Date.now(),tags:{resource_type:this.getResourceType(r.name),resource_size:(null==(t=r.transferSize)?void 0:t.toString())||"unknown"}})}});e.observe({entryTypes:["resource"]}),this.observers.push(e)}catch(e){console.warn("Failed to initialize resource observer:",e)}try{let e=new PerformanceObserver(e=>{for(let t of e.getEntries())"longtask"===t.entryType&&this.recordMetric({name:"long_task_duration",value:Math.round(t.duration),unit:"ms",timestamp:Date.now()})});e.observe({entryTypes:["longtask"]}),this.observers.push(e)}catch(e){console.warn("Failed to initialize long task observer:",e)}}getResourceType(e){return e.includes(".js")?"script":e.includes(".css")?"stylesheet":e.includes(".png")||e.includes(".jpg")||e.includes(".jpeg")||e.includes(".gif")||e.includes(".webp")?"image":e.includes(".woff")||e.includes(".ttf")?"font":e.includes("/api/")?"api":"other"}monitorMemory(){if("memory"in performance){let e=performance.memory;this.recordMetric({name:"memory_used",value:Math.round(e.usedJSHeapSize/1024/1024),unit:"bytes",timestamp:Date.now()}),this.recordMetric({name:"memory_total",value:Math.round(e.totalJSHeapSize/1024/1024),unit:"bytes",timestamp:Date.now()}),this.recordMetric({name:"memory_limit",value:Math.round(e.jsHeapSizeLimit/1024/1024),unit:"bytes",timestamp:Date.now()})}}getSummary(){let e=Date.now(),t=this.metrics.filter(t=>t.timestamp>e-3e5),r={},n=[],s=[],a=t.filter(e=>"page_load_time"===e.name);if(a.length>0){let e=a.reduce((e,t)=>e+t.value,0)/a.length;r.avgPageLoadTime=Math.round(e),e>3e3&&(n.push(...a.filter(e=>e.value>3e3)),s.push("Consider optimizing page load performance"))}let o=t.filter(e=>e.name.includes("_duration")&&e.name.includes("api"));if(o.length>0){let e=o.reduce((e,t)=>e+t.value,0)/o.length;r.avgApiTime=Math.round(e),e>1e3&&(n.push(...o.filter(e=>e.value>1e3)),s.push("API calls are slow, consider optimization"))}let i=t.filter(e=>"memory_used"===e.name);if(i.length>0){let e=i[i.length-1];r.currentMemoryUsage=e.value,e.value>50&&(n.push(e),s.push("High memory usage detected"))}let c=t.filter(e=>"long_task_duration"===e.name);return c.length>0&&(r.longTaskCount=c.length,r.maxLongTaskDuration=Math.max(...c.map(e=>e.value)),c.length>5&&s.push("Multiple long tasks detected, consider code optimization")),{metrics:r,alerts:n,recommendations:s}}cleanup(){this.observers.forEach(e=>e.disconnect()),this.observers=[],this.metrics=[],this.entries.clear()}constructor(){this.metrics=[],this.entries=new Map,this.observers=[]}}{let e=a.getInstance();e.initializeObservers(),setInterval(()=>{e.monitorMemory()},3e4)}function o(e){let t=function(){let e=a.getInstance();return{startTimer:e.startTimer.bind(e),endTimer:e.endTimer.bind(e),measureFunction:e.measureFunction.bind(e),recordMetric:e.recordMetric.bind(e),getMetrics:e.getMetrics.bind(e),getMetricStats:e.getMetricStats.bind(e),getSummary:e.getSummary.bind(e),monitorMemory:e.monitorMemory.bind(e)}}(),r=(0,n.useRef)(void 0),o=(0,n.useRef)(0);(0,n.useEffect)(()=>(r.current=performance.now(),()=>{if(r.current){let n=performance.now()-r.current;t.recordMetric({name:"component_render_time",value:Math.round(n),unit:"ms",timestamp:Date.now(),tags:{component:e}})}}),[e,t]);let i=(0,n.useCallback)((r,n)=>{o.current+=1,t.recordMetric({name:"user_interaction",value:1,unit:"count",timestamp:Date.now(),tags:{component:e,action:r,interactionCount:o.current.toString()}});try{fetch("/api/analytics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:[{name:"user_interaction",data:{component:e,action:r,interactionCount:o.current,...n},timestamp:Date.now()}]})}).catch(t=>{(0,s.ow)("Failed to send interaction analytics",{action:"analytics_send",additionalData:{componentName:e,action:r,error:t.message}},t)})}catch(t){(0,s.ow)("Error tracking user interaction",{action:"interaction_tracking",additionalData:{componentName:e,action:r}},t)}},[e,t]),c=(0,n.useCallback)(async(r,n,s)=>await t.measureFunction("".concat(e,"_").concat(r),n,{component:e,operation:r,...s}),[e,t]),u=(0,n.useCallback)(async(r,n,s)=>await t.measureFunction("api_".concat(r),n,{component:e,api:r,...s}),[e,t]),l=(0,n.useCallback)((r,n,a,o)=>{t.recordMetric({name:"form_submission",value:1,unit:"count",timestamp:Date.now(),tags:{component:e,form:r,success:a.toString()}});try{fetch("/api/analytics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:[{name:"form_submission",data:{component:e,form:r,success:a,error:null==o?void 0:o.message,fieldCount:Object.keys(n).length},timestamp:Date.now()}]})}).catch(t=>{(0,s.ow)("Failed to send form analytics",{action:"analytics_send",additionalData:{componentName:e,formName:r,error:t.message}},t)})}catch(t){(0,s.ow)("Error tracking form submission",{action:"form_tracking",additionalData:{componentName:e,formName:r}},t)}},[e,t]),d=(0,n.useCallback)((r,n)=>{t.recordMetric({name:"component_error",value:1,unit:"count",timestamp:Date.now(),tags:{component:e,errorType:r.constructor.name,errorMessage:r.message}}),(0,s.ow)("Error in ".concat(e),{action:"component_error",additionalData:{componentName:e,context:n,error:r.message}},r)},[e,t]);return(0,n.useEffect)(()=>{let r=()=>{t.recordMetric({name:"page_visibility_change",value:+!document.hidden,unit:"count",timestamp:Date.now(),tags:{component:e,state:document.hidden?"hidden":"visible"}})};return document.addEventListener("visibilitychange",r),()=>document.removeEventListener("visibilitychange",r)},[e,t]),{trackInteraction:i,trackAsyncOperation:c,trackApiCall:u,trackFormSubmission:l,trackError:d}}},32841:(e,t,r)=>{r.d(t,{ow:()=>i,sY:()=>o}),r(42094);var n=r(54096);class s{static getInstance(){return s.instance||(s.instance=new s),s.instance}generateErrorId(){return"err_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}getContext(){return{timestamp:Date.now(),url:window.location.href,userAgent:navigator.userAgent}}handleGlobalError(e){this.logError(e.message||"Unknown error","system","high",{...this.getContext(),component:"global",additionalData:{filename:e.filename,lineno:e.lineno,colno:e.colno}},e.error)}handleUnhandledRejection(e){this.logError("Unhandled promise rejection","system","high",{...this.getContext(),component:"promise",additionalData:{reason:e.reason}},e.reason)}logError(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=arguments.length>4?arguments[4]:void 0,a=this.generateErrorId(),o={id:a,message:e,category:t,severity:r,context:{timestamp:Date.now(),...this.getContext(),...n},stack:s instanceof Error?s.stack:void 0,originalError:s};this.errors.push(o),this.errors.length>this.maxErrors&&(this.errors=this.errors.slice(-this.maxErrors)),this.shouldLogToConsole&&this.logErrorToConsole(o),this.shouldLogToService&&this.sendToErrorService(o).catch(e=>{console.error("Failed to send error to logging service:",e)});try{let e=JSON.parse(localStorage.getItem("error_logs")||"[]");e.push(o),e.length>50&&e.splice(0,e.length-50),localStorage.setItem("error_logs",JSON.stringify(e))}catch(e){console.warn("Failed to store error in localStorage:",e)}return a}logErrorToConsole(e){let{severity:t,message:r,category:n,context:s,stack:a}=e,o=this.getSeverityEmoji(t);console.group("".concat(o," [").concat(t.toUpperCase(),"] ").concat(n,": ").concat(r)),console.log("Context:",s),a&&console.log("Stack trace:",a),console.groupEnd()}getSeverityEmoji(e){switch(e){case"low":return"\uD83D\uDFE1";case"medium":return"\uD83D\uDFE0";case"high":return"\uD83D\uDD34";case"critical":return"\uD83D\uDC80";default:return"⚪"}}async sendToErrorService(e){try{let t=await fetch("/api/errors",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error("HTTP ".concat(t.status,": ").concat(t.statusText))}catch(e){console.error("Failed to send error to service:",e)}}getErrors(e){return e?this.errors.slice(-e):[...this.errors]}clearErrors(){this.errors=[]}getErrorStats(){let e={low:0,medium:0,high:0,critical:0};return this.errors.forEach(t=>{e[t.severity]++}),e}constructor(){this.errors=[],this.maxErrors=100,this.shouldLogToConsole=!1,this.shouldLogToService="true"===n.env.NEXT_PUBLIC_ERROR_LOGGING,window.addEventListener("error",this.handleGlobalError.bind(this)),window.addEventListener("unhandledrejection",this.handleUnhandledRejection.bind(this))}}let a=s.getInstance(),o=(e,t,r)=>a.logError(e,"database","high",t,r),i=(e,t,r)=>a.logError(e,"system","medium",t,r)},52392:(e,t,r)=>{r.d(t,{aC:()=>o,fD:()=>a});var n=r(76057);class s{static getInstance(){return s.instance||(s.instance=new s),s.instance}async initializeAuth(){return this.authPromise||(this.authPromise=this.performAuthInitialization()),this.authPromise}async performAuthInitialization(){try{console.log("\uD83D\uDD10 Initializing enhanced Farcaster authentication...");let e=this.getCachedUser();if(e&&!this.isSessionExpired(e))return console.log("✅ Using cached user session"),this.currentUser=e,this.startSessionRefresh(),this.validateSessionWithSupabase(e).catch(e=>{console.warn("⚠️ Background session validation failed:",e)}),e;let{sdk:t}=await Promise.all([r.e(127),r.e(628),r.e(514)]).then(r.bind(r,92966)),n=0;for(;n<5;)try{let e=5e3*Math.pow(2,n);await Promise.race([t.actions.ready(),new Promise((t,r)=>setTimeout(()=>r(Error("SDK initialization timeout")),e))]),console.log("✅ Farcaster SDK initialized successfully");break}catch(a){let e=++n>=5;if(console.warn("⚠️ SDK initialization attempt ".concat(n,"/").concat(5," failed:"),a),e)throw Error("Failed to initialize Farcaster SDK after ".concat(5," attempts. Last error: ").concat(a));let t=1e3*n,r=1e3*Math.random(),s=Math.min(t+r,1e4);await new Promise(e=>setTimeout(e,s))}let s=await Promise.race([this.getUserContextWithValidation(t),new Promise((e,t)=>setTimeout(()=>t(Error("User context timeout after 10 seconds")),1e4))]);if(console.log("\uD83D\uDCCB Enhanced Farcaster context retrieved:",s),!(null==s?void 0:s.user))throw Error("No user context available from Farcaster SDK");let a=s.user.fid;if(!a||"number"!=typeof a||a<=0)throw Error("Invalid FID received from Farcaster SDK");let o=s.user.username||"user-".concat(a),i=s.user.displayName||o,c=this.validateAndSanitizePfpUrl(s.user.pfpUrl||""),u=await this.checkIsAdminWithFallback(a),l={address:"fid-".concat(a),username:this.sanitizeUsername(o),displayName:this.sanitizeDisplayName(i),pfpUrl:c,isAdmin:u,createdAt:Date.now(),lastActive:Date.now()};return this.cacheUserWithMetadata(l),await this.storeUserSessionWithRetry(a,l),this.startSessionRefresh(),this.currentUser=l,console.log("✅ Enhanced user authentication successful:",l),l}catch(e){return console.error("❌ Enhanced authentication failed:",e),this.currentUser=null,this.cleanup(),null}finally{this.authPromise=null}}async getUserContextWithValidation(e){try{let t=await e.context;if(!t||"object"!=typeof t)throw Error("Invalid context structure received");if(!t.user||"object"!=typeof t.user)throw Error("Invalid user object in context");let{user:r}=t;if(!r.fid)throw Error("Missing FID in user context");return t}catch(e){throw console.error("❌ Error retrieving user context:",e),e}}validateAndSanitizePfpUrl(e){if(!e||"string"!=typeof e)return"";try{let t=new URL(e);if("https:"!==t.protocol)return console.warn("⚠️ Insecure PFP URL protocol detected, using empty URL"),"";let r=t.hostname;if(!["vercel.app","supabase.co","farcaster.xyz","warpcast.com","ipfs.io","cloudflare-ipfs.com"].some(e=>r.includes(e)))return console.warn("⚠️ Untrusted PFP URL domain detected, using empty URL"),"";return e}catch(e){return console.warn("⚠️ Invalid PFP URL format, using empty URL:",e),""}}sanitizeUsername(e){return e&&"string"==typeof e&&e.replace(/[<>\"'&]/g,"").replace(/\s+/g,"_").substring(0,50).trim()||"unknown"}sanitizeDisplayName(e){return e&&"string"==typeof e&&e.replace(/[<>\"'&]/g,"").substring(0,100).trim()||"Unknown User"}async checkIsAdminWithFallback(e){try{if(await this.checkIsAdmin(e))return console.log("✅ User ".concat(e," confirmed as admin via database")),!0;if([250704,1107084].includes(e))return console.log("⚠️ User ".concat(e," is admin via fallback list, updating database...")),this.addAdminToFallbackList(e).catch(e=>{console.warn("⚠️ Failed to update admin database:",e)}),!0;return!1}catch(e){return console.error("❌ Error checking admin status:",e),!1}}async addAdminToFallbackList(e){try{let{error:t}=await n.E2.from("admin_fids").upsert({fid:e.toString(),permissions:{role:"admin",permissions:["all"],source:"fallback"},created_at:Date.now(),updated_at:Date.now()},{onConflict:"fid"});if(t)throw t;console.log("✅ Admin ".concat(e," added to database from fallback list"))}catch(e){throw console.error("❌ Failed to add admin to database:",e),e}}async checkIsAdmin(e){try{let{data:r,error:s}=await Promise.race([n.ND.from("admin_fids").select("fid, permissions").eq("fid",e.toString()).single(),new Promise((e,t)=>setTimeout(()=>t(Error("Admin check timeout")),5e3))]);if(s){if("code"in s&&"PGRST116"===s.code)return!1;return console.warn("⚠️ Error checking admin status:",s),!1}if(r&&r.permissions){var t;let e="string"==typeof r.permissions?JSON.parse(r.permissions):r.permissions;return"admin"===e.role||(null==(t=e.permissions)?void 0:t.includes("all"))}return!!r}catch(e){return console.error("❌ Error checking admin status:",e),!1}}async storeUserSessionWithRetry(e,t){let r=0;for(;r<3;)try{await this.storeUserSession(e,t);return}catch(n){let e=++r>=3;if(console.warn("⚠️ User session storage attempt ".concat(r,"/").concat(3," failed:"),n),e)return void console.error("❌ Failed to store user session after all retries:",n);let t=1e3*Math.pow(2,r-1);await new Promise(e=>setTimeout(e,t))}}async storeUserSession(e,t){try{let r={fid:e.toString(),session_data:{...t,sessionId:this.generateSessionId(),deviceInfo:this.getDeviceInfo(),lastUpdated:Date.now()},created_at:Date.now(),expires_at:Date.now()+this.SESSION_TIMEOUT},{error:s}=await n.E2.from("user_sessions").upsert(r,{onConflict:"fid"});if(s)throw Error("Database error: ".concat(s.message));console.log("✅ User session stored successfully")}catch(e){throw console.error("❌ Error storing user session:",e),e}}generateSessionId(){return"session_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,15))}getDeviceInfo(){try{return{userAgent:navigator.userAgent.substring(0,500),language:navigator.language||"unknown",platform:navigator.platform||"unknown",timestamp:new Date().toISOString()}}catch(e){return console.warn("⚠️ Error getting device info:",e),{userAgent:"unknown",language:"unknown",platform:"unknown",timestamp:new Date().toISOString()}}}cacheUserWithMetadata(e){try{let t={user:e,timestamp:Date.now(),version:"1.0",checksum:this.generateUserChecksum(e)};localStorage.setItem("bitcoin-blocks-user",JSON.stringify(t)),sessionStorage.setItem("bitcoin-blocks-user-backup",JSON.stringify(t))}catch(e){console.warn("⚠️ Error caching user with metadata:",e)}}generateUserChecksum(e){return btoa("".concat(e.address,"-").concat(e.username,"-").concat(e.isAdmin,"-").concat(e.lastActive)).substring(0,16)}getCachedUser(){try{let e=localStorage.getItem("bitcoin-blocks-user");if(e||(e=sessionStorage.getItem("bitcoin-blocks-user-backup")),!e)return null;let t=JSON.parse(e);if(!t.user||!t.timestamp||!t.checksum)return console.warn("⚠️ Invalid cache structure detected"),this.clearCache(),null;let r=this.generateUserChecksum(t.user);if(t.checksum!==r)return console.warn("⚠️ Cache checksum mismatch, possible tampering"),this.clearCache(),null;return t.user}catch(e){return console.warn("⚠️ Error getting cached user:",e),this.clearCache(),null}}clearCache(){try{localStorage.removeItem("bitcoin-blocks-user"),sessionStorage.removeItem("bitcoin-blocks-user-backup")}catch(e){console.warn("⚠️ Error clearing cache:",e)}}isSessionExpired(e){return!e.lastActive||Date.now()-e.lastActive>this.SESSION_TIMEOUT}startSessionRefresh(){this.sessionRefreshInterval&&clearInterval(this.sessionRefreshInterval),this.sessionRefreshInterval=setInterval(async()=>{if(this.currentUser)try{await this.refreshSession()}catch(e){console.error("❌ Error in session refresh:",e)}},this.REFRESH_INTERVAL)}async validateSessionWithSupabase(e){try{let t=e.address.replace("fid-",""),{data:r,error:s}=await n.ND.from("user_sessions").select("expires_at").eq("fid",t).single();if(s)throw Error("Session validation failed: ".concat(s.message));r&&Date.now()>r.expires_at&&(console.warn("⚠️ Session expired on server, clearing local cache"),this.signOut())}catch(e){console.warn("⚠️ Session validation error:",e)}}cleanup(){this.sessionRefreshInterval&&(clearInterval(this.sessionRefreshInterval),this.sessionRefreshInterval=null)}getCurrentUser(){return this.currentUser?this.isSessionExpired(this.currentUser)?(console.warn("⚠️ Current user session expired"),this.signOut(),null):this.currentUser:null}async signOut(){try{this.cleanup(),this.clearCache(),this.currentUser=null,this.authPromise=null,await n.ND.auth.signOut().catch(e=>{console.warn("⚠️ Error signing out from Supabase:",e)}),console.log("✅ User signed out successfully")}catch(e){console.error("❌ Error signing out:",e)}}async refreshSession(){if(!this.currentUser)return null;try{let e=Date.now();this.currentUser.lastActive=e,this.cacheUserWithMetadata(this.currentUser);let t=parseInt(this.currentUser.address.replace("fid-",""));return this.storeUserSession(t,this.currentUser).catch(e=>{console.warn("⚠️ Failed to update session in background:",e)}),this.currentUser}catch(e){return console.error("❌ Error refreshing session:",e),null}}async updateProfile(e){if(!this.currentUser)return null;try{let t=this.validateProfileUpdates(e),r={...this.currentUser,...t,lastActive:Date.now()};this.cacheUserWithMetadata(r);let n=parseInt(this.currentUser.address.replace("fid-",""));return await this.storeUserSession(n,r),this.currentUser=r,console.log("✅ User profile updated successfully"),r}catch(e){return console.error("❌ Error updating user profile:",e),null}}validateProfileUpdates(e){let t={};return void 0!==e.username&&(t.username=this.sanitizeUsername(e.username)),void 0!==e.displayName&&(t.displayName=this.sanitizeDisplayName(e.displayName)),void 0!==e.pfpUrl&&(t.pfpUrl=this.validateAndSanitizePfpUrl(e.pfpUrl)),t}constructor(){this.currentUser=null,this.authPromise=null,this.sessionRefreshInterval=null,this.SESSION_TIMEOUT=864e5,this.REFRESH_INTERVAL=18e5}}let a=s.getInstance();async function o(e){if(!e)return void await n.ND.rpc("reset_config");let t=e.address.replace("fid-",""),{error:r}=await n.ND.rpc("set_config",{key:"app.current_fid",value:t});r?console.warn("⚠️ Error setting Supabase context:",r):console.log("✅ Supabase context set for user:",t)}},72586:(e,t,r)=>{r.d(t,{GameProvider:()=>g,gD:()=>m,Im:()=>p});var n=r(46814),s=r(42094),a=r(52392),o=r(76057),i=r(32841);class c{static getInstance(){return c.instance||(c.instance=new c),c.instance}async retryQuery(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,n=null;for(let s=1;s<=t;s++)try{let a=await Promise.race([e(),new Promise((e,t)=>setTimeout(()=>t(Error("Query timeout")),this.queryTimeout))]);if(a.error&&(n=a.error,s<t)){await new Promise(e=>setTimeout(e,r*s));continue}return a}catch(e){n=e,s<t&&await new Promise(e=>setTimeout(e,r*s))}return{data:null,error:n}}async batchQuery(e){try{return await Promise.allSettled(e.map(e=>this.retryQuery(e))).then(e=>e.map(e=>"fulfilled"===e.status?e.value:{data:null,error:e.reason}))}catch(t){return await (0,i.ow)("Batch query failed",{action:"batch_query",additionalData:{queryCount:e.length}},t),e.map(()=>({data:null,error:t}))}}async getRounds(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50,t=arguments.length>1?arguments[1]:void 0;try{let{data:r,error:n}=await this.retryQuery(async()=>{let r=o.ND.from("rounds").select("*").order("created_at",{ascending:!1}).limit(e);return t&&(r=r.eq("status",t)),await r});if(n)return await (0,i.ow)("Error fetching rounds",{action:"fetch_rounds",additionalData:{limit:e,status:t}},n),[];return this.transformRounds(r||[])}catch(r){return await (0,i.ow)("Unexpected error fetching rounds",{action:"fetch_rounds_unexpected",additionalData:{limit:e,status:t}},r),[]}}async getActiveRound(){try{let{data:e,error:t}=await this.retryQuery(async()=>o.ND.from("rounds").select("*").eq("status","open").single());if(t&&"PGRST116"!==t.code)return await (0,i.ow)("Error fetching active round",{action:"fetch_active_round"},t),null;return e?this.transformRound(e):null}catch(e){return await (0,i.ow)("Unexpected error fetching active round",{action:"fetch_active_round_unexpected"},e),null}}async getRoundsPaginated(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,r=arguments.length>2?arguments[2]:void 0;try{var n;let s=(e-1)*t,[a,c]=await Promise.all([this.retryQuery(async()=>{let e=o.ND.from("rounds").select("*").order("created_at",{ascending:!1}).range(s,s+t-1);return r&&(e=e.eq("status",r)),await e}),this.retryQuery(async()=>{let e=o.ND.from("rounds").select("*",{count:"exact",head:!0});return r&&(e=e.eq("status",r)),await e})]);a.error&&await (0,i.ow)("Error fetching paginated rounds",{action:"fetch_rounds_paginated",additionalData:{page:e,limit:t,status:r}},a.error);let u=(null==(n=c.data)?void 0:n.count)||0,l=s+t<u;return{rounds:this.transformRounds(a.data||[]),totalCount:u,hasMore:l}}catch(n){return await (0,i.ow)("Unexpected error fetching paginated rounds",{action:"fetch_rounds_paginated_unexpected",additionalData:{page:e,limit:t,status:r}},n),{rounds:[],totalCount:0,hasMore:!1}}}async getRoundsWithStats(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;try{let{data:t,error:r}=await this.retryQuery(async()=>o.ND.from("rounds").select("\n            *,\n            guesses(count)\n          ").order("created_at",{ascending:!1}).limit(e));if(r)return await (0,i.ow)("Error fetching rounds with stats",{action:"fetch_rounds_stats"},r),[];return(t||[]).map(e=>{var t,r;return{...this.transformRound(e),participationCount:(null==(r=e.guesses)||null==(t=r[0])?void 0:t.count)||0,averageGuess:0}})}catch(e){return await (0,i.ow)("Unexpected error fetching rounds with stats",{action:"fetch_rounds_stats_unexpected"},e),[]}}async createRound(e){try{let t=Date.now(),{data:r,error:n}=await o.E2.from("rounds").insert({round_number:e.roundNumber,start_time:e.startTime,end_time:e.endTime,prize:e.prize,status:"open",block_number:e.blockNumber,created_at:t,duration:e.duration}).select().single();if(n)return console.error("❌ Error creating round:",n),null;let s=this.transformRound(r);return console.log("✅ Round created successfully:",s),await this.logAction("round_created","Round #".concat(e.roundNumber," created"),{roundId:s.id,roundNumber:e.roundNumber,prize:e.prize}),s}catch(e){return console.error("❌ Unexpected error creating round:",e),null}}async updateRound(e,t){try{let{data:r,error:n}=await o.E2.from("rounds").update(this.transformRoundToDb(t)).eq("id",e).select().single();if(n)return console.error("❌ Error updating round:",n),null;let s=this.transformRound(r);return console.log("✅ Round updated successfully:",s),s}catch(e){return console.error("❌ Unexpected error updating round:",e),null}}async endRound(e){try{let{error:t}=await o.E2.from("rounds").update({status:"closed"}).eq("id",e);if(t)return console.error("❌ Error ending round:",t),!1;return console.log("✅ Round ended successfully:",e),await this.logAction("round_ended","Round ".concat(e," ended"),{roundId:e}),!0}catch(e){return console.error("❌ Unexpected error ending round:",e),!1}}async updateRoundResult(e,t,r,n){try{let{error:s}=await o.E2.from("rounds").update({status:"finished",actual_tx_count:t,block_hash:r,winning_fid:n}).eq("id",e);if(s)return console.error("❌ Error updating round result:",s),!1;return console.log("✅ Round result updated successfully:",e),await this.logAction("round_finished","Round ".concat(e," finished"),{roundId:e,actualTxCount:t,blockHash:r,winningFid:n}),!0}catch(e){return console.error("❌ Unexpected error updating round result:",e),!1}}async getGuessesForRound(e){try{let{data:t,error:r}=await o.ND.from("guesses").select("*").eq("round_id",e).order("created_at",{ascending:!0});if(r)return console.error("❌ Error fetching guesses for round:",r),[];return this.transformGuesses(t||[])}catch(e){return console.error("❌ Unexpected error fetching guesses for round:",e),[]}}async submitGuess(e){try{let t=Date.now(),{data:r,error:n}=await o.ND.from("guesses").insert({round_id:e.roundId,user_fid:e.userFid,guess_amount:e.guessAmount,created_at:t,username:e.username,pfp_url:e.pfpUrl}).select().single();if(n)return console.error("❌ Error submitting guess:",n),null;let s=this.transformGuess(r);return console.log("✅ Guess submitted successfully:",s),await this.logAction("guess_submitted","".concat(e.username," predicted ").concat(e.guessAmount," transactions"),{roundId:e.roundId,userFid:e.userFid,guessAmount:e.guessAmount}),s}catch(e){return console.error("❌ Unexpected error submitting guess:",e),null}}async hasUserGuessed(e,t){try{let{data:r,error:n}=await o.ND.from("guesses").select("id").eq("round_id",e).eq("user_fid",t).single();if(n&&"PGRST116"!==n.code)return console.error("❌ Error checking if user guessed:",n),!1;return!!r}catch(e){return console.error("❌ Unexpected error checking if user guessed:",e),!1}}async getChatMessages(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;try{let{data:t,error:r}=await o.ND.from("chat_messages").select("*").order("created_at",{ascending:!1}).limit(e);if(r)return console.error("❌ Error fetching chat messages:",r),[];return this.transformChatMessages(t||[])}catch(e){return console.error("❌ Unexpected error fetching chat messages:",e),[]}}async addChatMessage(e){try{let t=Date.now(),{data:r,error:n}=await o.ND.from("chat_messages").insert({user_fid:e.userFid,username:e.username,message:e.message,type:e.type,created_at:t,round_id:e.roundId,pfp_url:e.pfpUrl}).select().single();if(n)return console.error("❌ Error adding chat message:",n),null;let s=this.transformChatMessage(r);return console.log("✅ Chat message added successfully:",s),s}catch(e){return console.error("❌ Unexpected error adding chat message:",e),null}}async getPrizeConfiguration(){try{let{data:e,error:t}=await o.ND.from("prize_configs").select("*").order("version",{ascending:!1}).limit(1).single();if(t&&"PGRST116"!==t.code)return console.error("❌ Error fetching prize configuration:",t),null;return e?this.transformPrizeConfig(e):null}catch(e){return console.error("❌ Unexpected error fetching prize configuration:",e),null}}async updatePrizeConfiguration(e){try{let t=Date.now(),{data:r}=await o.ND.from("prize_configs").select("version").order("version",{ascending:!1}).limit(1).single(),n=((null==r?void 0:r.version)||0)+1,{data:s,error:a}=await o.E2.from("prize_configs").insert({config_data:e,updated_at:t,version:n}).select().single();if(a)return console.error("❌ Error updating prize configuration:",a),null;let i=this.transformPrizeConfig(s);return console.log("✅ Prize configuration updated successfully:",i),await this.logAction("prize_config_updated","Prize configuration updated",e),i}catch(e){return console.error("❌ Unexpected error updating prize configuration:",e),null}}async getLogs(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;try{let{data:t,error:r}=await o.E2.from("audit_logs").select("*").order("created_at",{ascending:!1}).limit(e);if(r)return console.error("❌ Error fetching logs:",r),[];return this.transformLogs(t||[])}catch(e){return console.error("❌ Unexpected error fetching logs:",e),[]}}async getLeaderboard(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50;try{if(e){var r,n,s;let{data:a,error:c}=await this.retryQuery(async()=>o.ND.from("guesses").select("\n              user_fid,\n              username,\n              pfp_url,\n              guess_amount,\n              created_at,\n              rounds!inner(actual_tx_count)\n            ").eq("round_id",e).not("rounds.actual_tx_count","is",null).order("guess_amount",{ascending:!1}).limit(t));if(c)return await (0,i.ow)("Error fetching round leaderboard",{action:"fetch_leaderboard_round",additionalData:{roundId:e,limit:t}},c),[];let u=a||[],l=(null==(s=u[0])||null==(n=s.rounds)||null==(r=n[0])?void 0:r.actual_tx_count)||0;return u.map((e,t)=>({rank:t+1,userFid:e.user_fid,username:e.username,pfpUrl:e.pfp_url,totalPoints:100*(0===Math.abs(e.guess_amount-l)),correctGuesses:+(0===Math.abs(e.guess_amount-l)),totalParticipation:1,winRate:100*(0===Math.abs(e.guess_amount-l))}))}{let{data:e,error:r}=await this.retryQuery(async()=>o.ND.from("guesses").select("\n              user_fid,\n              username,\n              pfp_url,\n              guess_amount,\n              created_at,\n              rounds!inner(actual_tx_count, status)\n            ").eq("rounds.status","finished").not("rounds.actual_tx_count","is",null).order("created_at",{ascending:!1}));if(r)return await (0,i.ow)("Error fetching overall leaderboard",{action:"fetch_leaderboard_overall",additionalData:{limit:t}},r),[];let n=new Map;return(e||[]).forEach(e=>{var t,r;let s=e.user_fid,a=0===Math.abs(e.guess_amount-((null==(r=e.rounds)||null==(t=r[0])?void 0:t.actual_tx_count)||0));n.has(s)||n.set(s,{userFid:s,username:e.username,pfpUrl:e.pfp_url,totalPoints:0,correctGuesses:0,totalParticipation:0});let o=n.get(s);o.totalParticipation++,a&&(o.correctGuesses++,o.totalPoints+=100)}),Array.from(n.values()).map(e=>({...e,winRate:e.totalParticipation>0?Math.round(e.correctGuesses/e.totalParticipation*100):0})).sort((e,t)=>t.totalPoints-e.totalPoints||t.correctGuesses-e.correctGuesses).slice(0,t).map((e,t)=>({...e,rank:t+1}))}}catch(r){return await (0,i.ow)("Unexpected error fetching leaderboard",{action:"fetch_leaderboard_unexpected",additionalData:{roundId:e,limit:t}},r),[]}}async getUserStats(e){try{let{data:t,error:r}=await this.retryQuery(async()=>o.ND.from("guesses").select("\n            guess_amount,\n            created_at,\n            round_id,\n            rounds!inner(actual_tx_count, status)\n          ").eq("user_fid",e).eq("rounds.status","finished").not("rounds.actual_tx_count","is",null).order("created_at",{ascending:!1}));if(r)return await (0,i.ow)("Error fetching user stats",{action:"fetch_user_stats",additionalData:{userFid:e}},r),{totalRounds:0,correctGuesses:0,totalWins:0,averageGuess:0,bestGuess:0,recentActivity:[]};let n=t||[],s=n.filter(e=>{var t,r;return 0===Math.abs(e.guess_amount-((null==(r=e.rounds)||null==(t=r[0])?void 0:t.actual_tx_count)||0))}),a=n.slice(0,10).map(e=>{var t,r,n,s;return{roundId:e.round_id,guess:e.guess_amount,actual:(null==(r=e.rounds)||null==(t=r[0])?void 0:t.actual_tx_count)||0,isCorrect:0===Math.abs(e.guess_amount-((null==(s=e.rounds)||null==(n=s[0])?void 0:n.actual_tx_count)||0))}});return{totalRounds:n.length,correctGuesses:s.length,totalWins:s.length,averageGuess:n.length>0?Math.round(n.reduce((e,t)=>e+t.guess_amount,0)/n.length):0,bestGuess:Math.min(...n.map(e=>{var t,r;return Math.abs(e.guess_amount-((null==(r=e.rounds)||null==(t=r[0])?void 0:t.actual_tx_count)||0))})),recentActivity:a}}catch(t){return await (0,i.ow)("Unexpected error fetching user stats",{action:"fetch_user_stats_unexpected",additionalData:{userFid:e}},t),{totalRounds:0,correctGuesses:0,totalWins:0,averageGuess:0,bestGuess:0,recentActivity:[]}}}async getGameStats(){try{var e,t,r,n;let[s,a,i,c]=await Promise.all([this.retryQuery(async()=>await o.ND.from("rounds").select("*",{count:"exact",head:!0})),this.retryQuery(async()=>await o.ND.from("rounds").select("*",{count:"exact",head:!0}).eq("status","open")),this.retryQuery(async()=>await o.ND.from("guesses").select("*",{count:"exact",head:!0})),this.retryQuery(async()=>await o.ND.from("guesses").select("user_fid",{count:"exact",head:!0}))]),u=(null==(e=s.data)?void 0:e.count)||0,l=(null==(t=a.data)?void 0:t.count)||0,d=(null==(r=i.data)?void 0:r.count)||0,h=(null==(n=c.data)?void 0:n.count)||0;return{totalRounds:u,activeRounds:l,totalGuesses:d,totalUsers:h,averageParticipation:u>0?Math.round(d/u):0}}catch(e){return await (0,i.ow)("Unexpected error fetching game stats",{action:"fetch_game_stats_unexpected"},e),{totalRounds:0,activeRounds:0,totalGuesses:0,totalUsers:0,averageParticipation:0}}}async logAction(e,t,r){try{let{error:n}=await o.E2.from("audit_logs").insert({admin_fid:"system",action:e,details:{message:t,...r},created_at:Date.now()});n&&console.warn("⚠️ Error logging action:",n)}catch(e){console.warn("⚠️ Unexpected error logging action:",e)}}subscribeToRounds(e){let t=o.ND.channel("rounds_changes").on("postgres_changes",{event:"*",schema:"public",table:"rounds"},t=>{("INSERT"===t.eventType||"UPDATE"===t.eventType)&&e(this.transformRound(t.new))}).subscribe();return()=>{o.ND.removeChannel(t)}}subscribeToGuesses(e){let t=o.ND.channel("guesses_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},t=>{e(this.transformGuess(t.new))}).subscribe();return()=>{o.ND.removeChannel(t)}}subscribeToChatMessages(e){let t=o.ND.channel("chat_messages_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages"},t=>{e(this.transformChatMessage(t.new))}).subscribe();return()=>{o.ND.removeChannel(t)}}subscribeToPrizeConfigs(e){let t=o.ND.channel("prize_configs_changes").on("postgres_changes",{event:"*",schema:"public",table:"prize_configs"},t=>{("INSERT"===t.eventType||"UPDATE"===t.eventType)&&e(this.transformPrizeConfig(t.new))}).subscribe();return()=>{o.ND.removeChannel(t)}}transformRounds(e){return e.map(e=>this.transformRound(e))}transformRound(e){return{id:e.id,roundNumber:e.round_number,startTime:e.start_time,endTime:e.end_time,prize:e.prize,status:e.status,blockNumber:e.block_number,actualTxCount:e.actual_tx_count,winningAddress:e.winning_fid,blockHash:e.block_hash,createdAt:e.created_at,duration:e.duration}}transformRoundToDb(e){let t={};return void 0!==e.roundNumber&&(t.round_number=e.roundNumber),void 0!==e.startTime&&(t.start_time=e.startTime),void 0!==e.endTime&&(t.end_time=e.endTime),void 0!==e.prize&&(t.prize=e.prize),void 0!==e.status&&(t.status=e.status),void 0!==e.blockNumber&&(t.block_number=e.blockNumber),void 0!==e.actualTxCount&&(t.actual_tx_count=e.actualTxCount),void 0!==e.winningAddress&&(t.winning_fid=e.winningAddress),void 0!==e.blockHash&&(t.block_hash=e.blockHash),void 0!==e.createdAt&&(t.created_at=e.createdAt),void 0!==e.duration&&(t.duration=e.duration),t}transformGuesses(e){return e.map(e=>this.transformGuess(e))}transformGuess(e){return{id:e.id,roundId:e.round_id,address:e.user_fid,username:e.username,guess:e.guess_amount,pfpUrl:e.pfp_url,submittedAt:e.created_at}}transformChatMessages(e){return e.map(e=>this.transformChatMessage(e))}transformChatMessage(e){return{id:e.id,roundId:e.round_id,address:e.user_fid,username:e.username,message:e.message,pfpUrl:e.pfp_url,timestamp:e.created_at,type:e.type}}transformPrizeConfig(e){return{id:e.id,jackpotAmount:e.config_data.jackpotAmount,firstPlaceAmount:e.config_data.firstPlaceAmount,secondPlaceAmount:e.config_data.secondPlaceAmount,currencyType:e.config_data.currencyType,tokenContractAddress:e.config_data.tokenContractAddress,updatedAt:e.updated_at}}transformLogs(e){return e.map(e=>this.transformLog(e))}transformLog(e){return{id:e.id,eventType:e.action,details:e.details.message||e.details,timestamp:e.created_at}}constructor(){this.queryTimeout=1e4}}let u=c.getInstance();var l=r(85);let d=(0,s.createContext)(void 0),h=["fid-250704","fid-1107084"];function m(e){return h.some(t=>t.toLowerCase()===e.toLowerCase())}function g(e){let{children:t}=e,{trackInteraction:r,trackAsyncOperation:c,trackApiCall:h,trackError:m}=(0,l.LC)("GameContext"),[g,p]=(0,s.useState)(null),[f,y]=(0,s.useState)([]),[w,v]=(0,s.useState)([]),[b,_]=(0,s.useState)([]),[E,S]=(0,s.useState)([]),[C,D]=(0,s.useState)(null),[U,I]=(0,s.useState)(!1),[M,T]=(0,s.useState)({rounds:!1,guesses:!1,chatMessages:!1,prizeConfig:!1,auth:!1,connection:!1}),[A,k]=(0,s.useState)({rounds:null,guesses:null,chatMessages:null,prizeConfig:null,auth:null,connection:null}),[R,P]=(0,s.useState)({lastSyncTime:Date.now(),syncCount:0,errorCount:0,getConnectionHealth:()=>o.nh.getConnectionStatus()}),x=(0,s.useRef)({guesses:new Map,chatMessages:new Map,rounds:new Map}),N=f.find(e=>"open"===e.status)||null,z={addGuessOptimistically:e=>{x.current.guesses.set(e.id,e),v(t=>t.find(t=>t.id===e.id)?t:[e,...t])},addChatMessageOptimistically:e=>{x.current.chatMessages.set(e.id,e),S(t=>t.find(t=>t.id===e.id)?t:[e,...t].slice(0,100))},updateRoundOptimistically:(e,t)=>{x.current.rounds.set(e,t),y(r=>r.map(r=>r.id===e?{...r,...t}:r))}},F={retryLoadRounds:async()=>{T(e=>({...e,rounds:!0})),k(e=>({...e,rounds:null}));try{await (0,o.vE)(async()=>{let e=await u.getRounds();y(e),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1}))})}catch(e){k(t=>({...t,rounds:e instanceof Error?e.message:"Failed to load rounds"})),P(e=>({...e,errorCount:e.errorCount+1}))}finally{T(e=>({...e,rounds:!1}))}},retryLoadChatMessages:async()=>{T(e=>({...e,chatMessages:!0})),k(e=>({...e,chatMessages:null}));try{await (0,o.vE)(async()=>{let e=await u.getChatMessages(100);S(e),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1}))})}catch(e){k(t=>({...t,chatMessages:e instanceof Error?e.message:"Failed to load chat messages"})),P(e=>({...e,errorCount:e.errorCount+1}))}finally{T(e=>({...e,chatMessages:!1}))}},retryConnection:async()=>{T(e=>({...e,connection:!0})),k(e=>({...e,connection:null}));try{let e=await (0,o.vE)(async()=>{let e=o.nh.getConnectionStatus();if("boolean"!=typeof e)throw Error("Invalid connection status");return e});I(e),e&&await Promise.all([F.retryLoadRounds(),F.retryLoadChatMessages()])}catch(e){I(!1),k(t=>({...t,connection:e instanceof Error?e.message:"Connection failed"})),P(e=>({...e,errorCount:e.errorCount+1}))}finally{T(e=>({...e,connection:!1}))}}};(0,s.useEffect)(()=>((async()=>{try{console.log("\uD83D\uDE80 Initializing enhanced Bitcoin Blocks App with Supabase..."),I(!1),T(e=>({...e,connection:!0,auth:!0})),o.nh.startMonitoring(),o.nh.addListener(e=>{I(e),e?k(e=>({...e,connection:null})):k(e=>({...e,connection:"Connection to Supabase lost"}))});let e=await a.fD.initializeAuth();e?(p(e),await (0,a.aC)(e),console.log("✅ User authenticated:",e.username)):(console.warn("⚠️ User authentication failed or not available"),k(e=>({...e,auth:"Authentication failed. Please try again."}))),await G(),Q(),I(!0),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1})),console.log("✅ Enhanced app initialized successfully!")}catch(t){let e=t instanceof Error?t.message:"Initialization failed";console.error("❌ Failed to initialize app:",t),(0,i.ow)(e,{component:"GameContext",action:"initializeApp",userId:null==g?void 0:g.address},t),I(!1),k(t=>({...t,connection:e})),P(e=>({...e,errorCount:e.errorCount+1}))}finally{T(e=>({...e,connection:!1,auth:!1}))}})(),()=>{J(),o.nh.stopMonitoring()}),[]);let G=async()=>{let e=0;for(;e<3;)try{await L();return}catch(s){let t=++e>=3,r="Initial data load attempt ".concat(e,"/").concat(3," failed");if(console.warn("⚠️ ".concat(r,":"),s),(0,i.sY)(r,{component:"GameContext",action:"loadInitialDataWithRetry",additionalData:{retryCount:e,isLastRetry:t}},s),t){let e=Error("Failed to load initial data after ".concat(3," attempts"));throw(0,i.sY)(e.message,{component:"GameContext",action:"loadInitialDataWithRetry",additionalData:{finalAttempt:!0}},e),e}let n=1e3*Math.pow(2,e-1);await new Promise(e=>setTimeout(e,n))}},L=async()=>{await Promise.all([O(),B(),j()])},O=async()=>{await c("loadRounds",async()=>{try{T(e=>({...e,rounds:!0})),k(e=>({...e,rounds:null}));let e=await h("getRounds",()=>(0,o.vE)(async()=>await u.getRounds()));y(e);let t=e.filter(e=>"open"===e.status);if(t.length>0){let e=t.map(async e=>{let t=await h("getGuessesForRound",()=>(0,o.vE)(async()=>u.getGuessesForRound(e.id)));return{roundId:e.id,guesses:t}}),r=await Promise.all(e);v(e=>{let t=[...e];return r.forEach(e=>{let{roundId:r,guesses:n}=e;t=[...t=t.filter(e=>e.roundId!==r),...n]}),t})}console.log("✅ Enhanced rounds loaded successfully"),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1})),r("loadRounds",{roundsCount:e.length})}catch(t){let e=t instanceof Error?t.message:"Unknown error";console.error("❌ Error loading rounds:",t),m(t,{action:"loadRounds"}),(0,i.sY)(e,{component:"GameContext",action:"loadRounds",userId:null==g?void 0:g.address},t),k(t=>({...t,rounds:e})),P(e=>({...e,errorCount:e.errorCount+1}))}finally{T(e=>({...e,rounds:!1}))}})},B=async()=>{try{T(e=>({...e,prizeConfig:!0})),k(e=>({...e,prizeConfig:null}));let e=await (0,o.vE)(async()=>u.getPrizeConfiguration());D(e),console.log("✅ Enhanced prize configuration loaded successfully"),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1}))}catch(e){console.error("❌ Error loading prize configuration:",e),k(t=>({...t,prizeConfig:e instanceof Error?e.message:"Unknown error"})),P(e=>({...e,errorCount:e.errorCount+1}))}finally{T(e=>({...e,prizeConfig:!1}))}},j=async()=>{try{T(e=>({...e,chatMessages:!0})),k(e=>({...e,chatMessages:null}));let e=await (0,o.vE)(async()=>u.getChatMessages(100));S(e),console.log("✅ Enhanced chat messages loaded successfully"),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1}))}catch(e){console.error("❌ Error loading chat messages:",e),k(t=>({...t,chatMessages:e instanceof Error?e.message:"Unknown error"})),P(e=>({...e,errorCount:e.errorCount+1}))}finally{T(e=>({...e,chatMessages:!1}))}},q=[],Q=()=>{console.log("\uD83D\uDD04 Setting up enhanced realtime subscriptions...");let e=u.subscribeToRounds(e=>{console.log("\uD83D\uDD04 Realtime round update:",e),x.current.rounds.get(e.id)&&(x.current.rounds.delete(e.id),console.log("✅ Optimistic update confirmed for round:",e.id)),y(t=>t.find(t=>t.id===e.id)?t.map(t=>t.id===e.id?e:t):[e,...t]),"open"===e.status&&(0,o.vE)(async()=>{let t=await u.getGuessesForRound(e.id);v(r=>[...r.filter(t=>t.roundId!==e.id),...t])}).catch(e=>{console.error("❌ Failed to load guesses for new round:",e),k(e=>({...e,guesses:"Failed to load predictions for new round"}))}),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1}))});q.push(e);let t=u.subscribeToGuesses(e=>{console.log("\uD83D\uDD04 Realtime guess update:",e),x.current.guesses.get(e.id)&&(x.current.guesses.delete(e.id),console.log("✅ Optimistic guess confirmed:",e.id)),v(t=>t.find(t=>t.id===e.id)?t:[e,...t]),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1}))});q.push(t);let r=u.subscribeToChatMessages(e=>{console.log("\uD83D\uDD04 Realtime chat message:",e),x.current.chatMessages.get(e.id)&&(x.current.chatMessages.delete(e.id),console.log("✅ Optimistic chat message confirmed:",e.id)),S(t=>t.find(t=>t.id===e.id)?t:[e,...t].slice(0,100)),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1}))});q.push(r);let n=u.subscribeToPrizeConfigs(e=>{console.log("\uD83D\uDD04 Realtime prize config update:",e),e&&"object"==typeof e?(D(e),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1}))):console.warn("⚠️ Invalid prize config received:",e)});q.push(n),console.log("✅ Enhanced realtime subscriptions set up successfully")},J=()=>{q.forEach(e=>{try{e()}catch(e){console.error("❌ Error cleaning up subscription:",e)}}),q.length=0,console.log("✅ Enhanced realtime subscriptions cleaned up")},W=(0,s.useCallback)(async(e,t,r,n,s,a)=>{if(console.log("\uD83C\uDFAE [SUPABASE] createRound called",{roundNumber:e,startTime:t,endTime:r,prize:n,blockNumber:s,duration:a,connected:U}),!U){let e="Not connected to database";throw console.error("❌",e),Error(e)}try{if(console.log("\uD83D\uDCE4 [SUPABASE] Creating round...",{roundNumber:e,duration:a,prize:n,blockNumber:s}),!await u.createRound({roundNumber:e,startTime:t,endTime:r,prize:n,blockNumber:s,duration:a}))throw Error("Failed to create round");console.log("✅ [SUPABASE] Round created successfully!")}catch(e){throw console.error("❌ [SUPABASE] Failed to create round:",e),e}},[U]),H=(0,s.useCallback)(async(e,t,n,s,a)=>await c("submitGuess",async()=>{if(!U)return console.warn("⚠️ [SUPABASE] Not connected"),!1;let c=f.find(t=>t.id===e);if(!c||"open"!==c.status)return console.warn("⚠️ [SUPABASE] Round not open:",{roundId:e,status:null==c?void 0:c.status}),!1;if(Date.now()>=c.endTime)return console.warn("⚠️ [SUPABASE] Round time expired"),!1;if(w.some(r=>r.roundId===e&&r.address.toLowerCase()===t.toLowerCase()))return console.warn("⚠️ [SUPABASE] User already guessed"),!1;try{let i=t.replace("fid-",""),c={id:"temp-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),roundId:e,address:t,username:n,guess:s,pfpUrl:a,submittedAt:Date.now()};if(z.addGuessOptimistically(c),!await h("submitGuess",()=>(0,o.vE)(async()=>u.submitGuess({roundId:e,userFid:i,username:n,guessAmount:s,pfpUrl:a}))))return v(e=>e.filter(e=>e.id!==c.id)),console.error("❌ [SUPABASE] Failed to submit guess"),k(e=>({...e,guesses:"Failed to submit prediction. Please try again."})),P(e=>({...e,errorCount:e.errorCount+1})),!1;return console.log("✅ [SUPABASE] Guess submitted with optimistic update!"),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1})),r("submitGuess",{roundId:e,guessAmount:s,success:!0}),!0}catch(n){let r=n instanceof Error?n.message:"Failed to submit prediction";return console.error("❌ [SUPABASE] Failed to submit guess:",n),m(n,{action:"submitGuess",roundId:e,guessAmount:s}),(0,i.sY)(r,{component:"GameContext",action:"submitGuess",additionalData:{roundId:e,userFid:t.replace("fid-",""),guessAmount:s}},n),k(e=>({...e,guesses:r})),P(e=>({...e,errorCount:e.errorCount+1})),!1}}),[U,f,w,c,h,r,m]),Y=(0,s.useCallback)(async e=>{if(!U)return console.warn("⚠️ [SUPABASE] Not connected"),!1;let t=f.find(t=>t.id===e);if(!t||"open"!==t.status)return console.warn("⚠️ [SUPABASE] Round not open:",{roundId:e,status:null==t?void 0:t.status}),!1;try{if(!await u.endRound(e))return console.error("❌ [SUPABASE] Failed to end round"),!1;return console.log("✅ [SUPABASE] Round ended!"),!0}catch(e){return console.error("❌ [SUPABASE] Failed to end round:",e),!1}},[U,f]),K=(0,s.useCallback)(async(e,t,r,n)=>{if(!U)throw Error("Not connected to database");try{if(!await u.updateRoundResult(e,t,r,n))throw Error("Failed to update round result");console.log("✅ [SUPABASE] Round result updated!")}catch(e){throw console.error("❌ [SUPABASE] Failed to update round result:",e),e}},[U]),V=(0,s.useCallback)(e=>w.filter(t=>t.roundId===e),[w]),X=(0,s.useCallback)((e,t)=>w.some(r=>r.roundId===e&&r.address.toLowerCase()===t.toLowerCase()),[w]),Z=(0,s.useCallback)(async e=>await c("addChatMessage",async()=>{if(console.log("\uD83D\uDCAC [SUPABASE] Enhanced addChatMessage called",{message:e,connected:U}),!U){let e="Not connected to database";throw console.warn("⚠️ [SUPABASE]",e),k(t=>({...t,chatMessages:e})),Error(e)}try{console.log("\uD83D\uDCE4 [SUPABASE] Sending enhanced chat message...");let t=e.address.replace("fid-",""),n={...e,id:"temp-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),timestamp:Date.now()};if(z.addChatMessageOptimistically(n),!await h("addChatMessage",()=>(0,o.vE)(async()=>u.addChatMessage({userFid:t,username:e.username,message:e.message,type:e.type,roundId:e.roundId,pfpUrl:e.pfpUrl}))))throw S(e=>e.filter(e=>e.id!==n.id)),Error("Failed to send chat message");console.log("✅ [SUPABASE] Enhanced chat message sent with optimistic update!"),P(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1})),r("addChatMessage",{messageType:e.type,messageLength:e.message.length,success:!0})}catch(r){let t=r instanceof Error?r.message:"Failed to send message";throw console.error("❌ [SUPABASE] Failed to send chat message:",r),m(r,{action:"addChatMessage",messageType:e.type,messageLength:e.message.length}),(0,i.sY)(t,{component:"GameContext",action:"addChatMessage",additionalData:{messageType:e.type,userFid:e.address.replace("fid-","")}},r),k(e=>({...e,chatMessages:t})),P(e=>({...e,errorCount:e.errorCount+1})),r}}),[U,c,h,r,m]);(0,s.useEffect)(()=>{if(!N||!U)return;let e=setInterval(()=>{let e=Date.now();"open"===N.status&&e>=N.endTime&&Y(N.id).catch(console.error)},1e3);return()=>clearInterval(e)},[N,U,Y]);let $=(0,s.useCallback)(async e=>{p(e),await (0,a.aC)(e)},[]);return(0,n.jsx)(d.Provider,{value:{user:g,setUser:$,rounds:f,guesses:w,logs:b,chatMessages:E,activeRound:N,prizeConfig:C,createRound:W,submitGuess:H,endRound:Y,updateRoundResult:K,getGuessesForRound:V,hasUserGuessed:X,addChatMessage:Z,connected:U,client:u,mode:"supabase",loadingStates:M,errorStates:A,optimisticActions:z,performance:R,retryActions:F},children:t})}function p(){let e=(0,s.useContext)(d);if(void 0===e)throw Error("useGame must be used within a GameProvider");return e}},76057:(e,t,r)=>{r.d(t,{E2:()=>o,ND:()=>a,nh:()=>l,vE:()=>c});var n=r(14295),s=r(54096);console.log("\uD83D\uDD0D DEBUG - Supabase Client Initialization:",{runtime:"browser",nodeEnv:"production",nextRuntime:"",supabaseUrl:"configured",hasAnonKey:!0,timestamp:new Date().toISOString()});let a=(0,n.UU)("https://masgfwpxfytraiwkvbmg.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hc2dmd3B4Znl0cmFpd2t2Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTQ5NTYsImV4cCI6MjA3NjI3MDk1Nn0.QAVE2pVMR869KycgzXe2MaQyJTyQb-yZM5zfIbtsMDM",{db:{schema:"public"},realtime:{params:{eventsPerSecond:10,reconnectDelay:2e3,maxReconnectAttempts:10,heartbeatIntervalMs:3e4,wsCloseTimeout:5e3}},auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!1,debug:!1,flowType:"pkce"},global:{headers:{"x-application-name":"bitcoin-blocks-miniapp","x-application-version":"1.0.0","x-client-type":"web","x-content-type-options":"nosniff","x-frame-options":"DENY","x-xss-protection":"1; mode=block"}}}),o=(0,n.UU)("https://masgfwpxfytraiwkvbmg.supabase.co",s.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1,debug:!1},db:{schema:"public"},global:{headers:{"x-application-name":"bitcoin-blocks-miniapp-admin","x-application-version":"1.0.0","x-client-type":"admin","x-privilege-level":"service-role"}}});async function i(){try{let{data:e,error:t}=await a.from("rounds").select("id").limit(1).single();if(t&&"PGRST116"!==t.code)return console.warn("⚠️ Supabase connection check failed:",t),!1;return!0}catch(e){return console.error("❌ Supabase connection check error:",e),!1}}async function c(e){let t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;for(let s=1;s<=r;s++)try{return await e()}catch(a){if(t=a,s===r)throw console.error("❌ Supabase operation failed after ".concat(r," attempts:"),a),t;let e=n*Math.pow(2,s-1);console.warn("⚠️ Supabase operation attempt ".concat(s,"/").concat(r," failed, retrying in ").concat(e,"ms:"),a),await new Promise(t=>setTimeout(t,e))}throw t}class u{static getInstance(){return u.instance||(u.instance=new u),u.instance}startMonitoring(){this.checkInterval||(this.checkConnection(),this.checkInterval=setInterval(()=>{this.checkConnection()},this.CHECK_INTERVAL))}stopMonitoring(){this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null)}async checkConnection(){let e=await i();e!==this.isConnected&&(this.isConnected=e,this.notifyListeners(e),e?console.log("✅ Supabase connection restored"):console.warn("⚠️ Supabase connection lost"))}notifyListeners(e){this.listeners.forEach(t=>{try{t(e)}catch(e){console.error("❌ Error in connection listener:",e)}})}addListener(e){this.listeners.push(e)}removeListener(e){let t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}getConnectionStatus(){return this.isConnected}constructor(){this.isConnected=!1,this.checkInterval=null,this.CHECK_INTERVAL=3e4,this.listeners=[]}}let l=u.getInstance()}}]);