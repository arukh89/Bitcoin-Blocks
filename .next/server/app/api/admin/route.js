"use strict";(()=>{var e={};e.id=27,e.ids=[27],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},2895:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>j,routeModule:()=>h,serverHooks:()=>R,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>_});var s={};r.r(s),r.d(s,{GET:()=>m,POST:()=>g});var a=r(9682),n=r(1739),o=r(6442),i=r(9667),u=r(7677),d=r(7916),c=r(6007);let l=new Map;async function p(e){try{let t=e.headers.get("Authorization");if(!t||!t.startsWith("Bearer "))return null;let s=t.split(" ")[1];if(!s)return null;let{createClient:a}=await Promise.all([r.e(752),r.e(340)]).then(r.bind(r,3340)),n=a(),o=await n.verifyJwt({token:s,domain:"localhost:3000"}),{data:i}=await u.E2.from("admin_fids").select("fid, permissions").eq("fid",o.sub.toString()).single();if(!i||!function(e,t=30,r=6e4){let s=Date.now(),a=l.get(e);return!a||s>a.resetTime?(l.set(e,{count:1,resetTime:s+r}),!0):!(a.count>=t)&&(a.count++,!0)}(i.fid))return null;return{fid:i.fid,permissions:i.permissions||["read","write"]}}catch(t){return await (0,c.ow)("Admin verification failed",{action:"admin_verification",additionalData:{ip:e.headers.get("x-forwarded-for")||"unknown",userAgent:e.headers.get("user-agent")||"unknown"}},t),null}}async function f(e,t,r,s){try{await u.E2.from("audit_logs").insert({admin_fid:e,action:t,details:{...r,ip:s.headers.get("x-forwarded-for")||"unknown",userAgent:s.headers.get("user-agent")||"unknown",timestamp:new Date().toISOString()},created_at:Date.now()})}catch(e){console.error("Failed to log admin action:",e)}}async function m(e){let t=await p(e);if(!t)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),s=r.get("action");try{switch(s){case"stats":let[a,n,o,c,l]=await Promise.all([u.E2.from("rounds").select("id",{count:"exact"}),d.J.getActiveRound(),u.E2.from("guesses").select("id",{count:"exact"}),u.E2.from("user_sessions").select("fid",{count:"exact"}),u.E2.from("error_logs").select("id",{count:"exact"}).gte("created_at",new Date(Date.now()-864e5).toISOString())]);return await f(t.fid,"view_stats",{},e),i.NextResponse.json({rounds:a.count||0,activeRound:n,totalGuesses:o.count||0,totalUsers:c.count||0,recentErrors:l.count||0});case"rounds":let p=parseInt(r.get("page")||"1"),m=parseInt(r.get("limit")||"50"),g=r.get("status"),h=u.E2.from("rounds").select("*").order("created_at",{ascending:!1}).range((p-1)*m,p*m-1);g&&(h=h.eq("status",g));let{data:x,error:_}=await h;if(_)throw _;return await f(t.fid,"view_rounds",{page:p,limit:m,status:g},e),i.NextResponse.json({rounds:x||[]});case"logs":let R=parseInt(r.get("page")||"1"),j=parseInt(r.get("limit")||"50"),y=r.get("admin"),v=u.E2.from("audit_logs").select("*").order("created_at",{ascending:!1}).range((R-1)*j,R*j-1);y&&(v=v.eq("admin_fid",y));let{data:N,error:E}=await v;if(E)throw E;return await f(t.fid,"view_logs",{page:R,limit:j,adminFilter:y},e),i.NextResponse.json({logs:N||[]});case"users":let{data:k}=await u.E2.from("user_sessions").select("*").order("created_at",{ascending:!1}).limit(100);return await f(t.fid,"view_users",{},e),i.NextResponse.json({users:k||[]});case"system-health":let q=await w();return await f(t.fid,"view_system_health",{},e),i.NextResponse.json(q);default:return i.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return await (0,c.ow)("Admin GET request failed",{action:"admin_get",additionalData:{adminFid:t.fid,endpoint:s}},e),i.NextResponse.json({error:"Internal server error",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function g(e){let t,r=await p(e);if(!r)return i.NextResponse.json({error:"Unauthorized"},{status:401});try{let{action:s}=t=await e.json();switch(s){case"create-round":{let{roundNumber:e,startTime:s,endTime:a,prize:n,blockNumber:o,duration:c}=t;if(!e||!s||!a||!n)return i.NextResponse.json({error:"Missing required fields"},{status:400});let l=await d.J.createRound({roundNumber:e,startTime:s,endTime:a,prize:n,blockNumber:o,duration:c});if(!l)return i.NextResponse.json({error:"Failed to create round"},{status:500});return await u.E2.from("audit_logs").insert({admin_fid:r.fid,action:"create_round",details:{roundId:l.id,roundNumber:e,prize:n},created_at:Date.now()}),i.NextResponse.json({success:!0,round:l})}case"end-round":{let{roundId:e}=t;if(!e)return i.NextResponse.json({error:"Missing roundId"},{status:400});if(!await d.J.endRound(e))return i.NextResponse.json({error:"Failed to end round"},{status:500});return await u.E2.from("audit_logs").insert({admin_fid:r.fid,action:"end_round",details:{roundId:e},created_at:Date.now()}),i.NextResponse.json({success:!0})}case"update-round-result":{let{roundId:e,actualTxCount:s,blockHash:a,winningAddress:n}=t;if(!e||!s||!a||!n)return i.NextResponse.json({error:"Missing required fields"},{status:400});return await d.J.updateRoundResult(e,s,a,n),await u.E2.from("audit_logs").insert({admin_fid:r.fid,action:"update_round_result",details:{roundId:e,actualTxCount:s,blockHash:a,winningAddress:n},created_at:Date.now()}),i.NextResponse.json({success:!0})}case"update-prize-config":{let{jackpotAmount:e,firstPlaceAmount:s,secondPlaceAmount:a,currencyType:n,tokenContractAddress:o}=t;if(!e||!s||!a||!n)return i.NextResponse.json({error:"Missing required fields"},{status:400});let c=await d.J.updatePrizeConfiguration({jackpotAmount:e,firstPlaceAmount:s,secondPlaceAmount:a,currencyType:n,tokenContractAddress:o||"0x0000000000000000000000000000000000000000"});if(!c)return i.NextResponse.json({error:"Failed to update prize configuration"},{status:500});return await u.E2.from("audit_logs").insert({admin_fid:r.fid,action:"update_prize_config",details:{config:c},created_at:Date.now()}),i.NextResponse.json({success:!0,config:c})}case"batch-create-rounds":{let{rounds:s}=t;if(!s||!Array.isArray(s)||0===s.length)return i.NextResponse.json({error:"Invalid rounds array"},{status:400});let a=[];for(let e of s){let{roundNumber:t,startTime:r,endTime:s,prize:n,blockNumber:o,duration:i}=e;if(!t||!r||!s||!n){a.push({success:!1,error:"Missing required fields",roundNumber:t});continue}try{let e=await d.J.createRound({roundNumber:t,startTime:r,endTime:s,prize:n,blockNumber:o,duration:i});e?a.push({success:!0,round:e,roundNumber:t}):a.push({success:!1,error:"Failed to create round",roundNumber:t})}catch(e){a.push({success:!1,error:e instanceof Error?e.message:"Unknown error",roundNumber:t})}}return await f(r.fid,"batch_create_rounds",{requested:s.length,successful:a.filter(e=>e.success).length},e),i.NextResponse.json({results:a})}case"batch-end-rounds":{let{roundIds:s}=t;if(!s||!Array.isArray(s)||0===s.length)return i.NextResponse.json({error:"Invalid roundIds array"},{status:400});let a=[];for(let e of s)try{let t=await d.J.endRound(e);a.push({roundId:e,success:t})}catch(t){a.push({roundId:e,success:!1,error:t instanceof Error?t.message:"Unknown error"})}return await f(r.fid,"batch_end_rounds",{requested:s.length,successful:a.filter(e=>e.success).length},e),i.NextResponse.json({results:a})}case"delete-error-logs":{let s;if(!r.permissions?.includes("delete"))return i.NextResponse.json({error:"Insufficient permissions"},{status:403});let{olderThan:a}=t;if(!a)return i.NextResponse.json({error:"Missing olderThan parameter"},{status:400});s=new Date("string"==typeof a?a:Date.now()-24*a*36e5);let{error:n}=await u.E2.from("error_logs").delete().lt("created_at",s.toISOString());if(n)throw n;return await f(r.fid,"delete_error_logs",{cutoffDate:s.toISOString()},e),i.NextResponse.json({success:!0})}case"export-data":{let{dataType:s,format:a}=t;if(!s||!a)return i.NextResponse.json({error:"Missing dataType or format parameter"},{status:400});let n=[];switch(s){case"rounds":let{data:o}=await u.E2.from("rounds").select("*").order("created_at",{ascending:!1}).limit(1e3);n=o||[];break;case"guesses":let{data:d}=await u.E2.from("guesses").select("*").order("created_at",{ascending:!1}).limit(5e3);n=d||[];break;case"users":let{data:c}=await u.E2.from("user_sessions").select("*").order("created_at",{ascending:!1}).limit(1e3);n=c||[];break;default:return i.NextResponse.json({error:"Invalid dataType"},{status:400})}if(await f(r.fid,"export_data",{dataType:s,format:a,count:n.length},e),"csv"===a){let e=Object.keys(n[0]||{}),t=[e.join(","),...n.map(t=>e.map(e=>`"${t[e]||""}"`).join(","))].join("\n");return new i.NextResponse(t,{headers:{"Content-Type":"text/csv","Content-Disposition":`attachment; filename="${s}-${new Date().toISOString().split("T")[0]}.csv"`}})}return i.NextResponse.json({data:n})}default:return i.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return await (0,c.ow)("Admin POST request failed",{action:"admin_post",additionalData:{adminFid:r.fid,endpoint:t?.action||"unknown"}},e),i.NextResponse.json({error:"Internal server error",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function w(){try{let[e,t,r,s]=await Promise.all([u.E2.from("rounds").select("id").limit(1),u.E2.from("error_logs").select("id",{count:"exact"}).gte("created_at",new Date(Date.now()-36e5).toISOString()),Promise.resolve(25),Promise.all([fetch("https://mempool.space/api/blocks?type=hour",{method:"HEAD",signal:AbortSignal.timeout(5e3)}).then(e=>({api:"mempool",status:e.ok?"healthy":"unhealthy"})).catch(()=>({api:"mempool",status:"unhealthy"})),fetch("https://api.farcaster.xyz/v2/casts",{method:"HEAD",signal:AbortSignal.timeout(5e3)}).then(e=>({api:"farcaster",status:e.ok?"healthy":"unhealthy"})).catch(()=>({api:"farcaster",status:"unhealthy"}))])]);return{status:"healthy",timestamp:new Date().toISOString(),database:e.error?"unhealthy":"healthy",recentErrors:t.count||0,activeConnections:r,externalApis:s.reduce((e,t)=>(e[t.api]=t.status,e),{})}}catch(e){return{status:"unhealthy",timestamp:new Date().toISOString(),error:e instanceof Error?e.message:"Unknown error"}}}let h=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/admin/route",pathname:"/api/admin",filename:"route",bundlePath:"app/api/admin/route"},resolvedPagePath:"c:\\Users\\UserBQ\\Downloads\\mini app\\blocks\\src\\app\\api\\admin\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:x,workUnitAsyncStorage:_,serverHooks:R}=h;function j(){return(0,o.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:_})}},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3939:e=>{e.exports=require("@supabase/supabase-js")},4573:e=>{e.exports=require("node:buffer")},4708:e=>{e.exports=require("node:https")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7067:e=>{e.exports=require("node:http")},7598:e=>{e.exports=require("node:crypto")},7975:e=>{e.exports=require("node:util")},8474:e=>{e.exports=require("node:events")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[859,176,839],()=>r(2895));module.exports=s})();