"use strict";(()=>{var e={};e.id=70,e.ids=[70],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},2618:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>N,routeModule:()=>O,serverHooks:()=>z,workAsyncStorage:()=>A,workUnitAsyncStorage:()=>P});var a={};r.r(a),r.d(a,{GET:()=>g,POST:()=>q});var s=r(9682),n=r(1739),i=r(6442),o=r(9667),c=r(7677),u=r(7916),l=r(6007);class d{static getInstance(){return d.instance||(d.instance=new d),d.instance}startTimer(e,t){this.entries.set(e,{name:e,startTime:performance.now(),metadata:t})}endTimer(e,t){let r=this.entries.get(e);if(!r)return console.warn(`Timer '${e}' was not started`),null;let a=performance.now()-r.startTime;return this.recordMetric({name:`${e}_duration`,value:Math.round(a),unit:"ms",timestamp:Date.now(),tags:{...r.metadata,...t}}),this.entries.delete(e),a}recordMetric(e){this.metrics.push(e),this.metrics.length>1e3&&(this.metrics=this.metrics.slice(-1e3)),e.value>("ms"===e.unit?1e3:"percent"===e.unit?90:1e6)&&(0,l.ow)(`High ${e.name} detected`,{action:"performance_alert",additionalData:{metric:e.name,value:e.value,unit:e.unit,tags:e.tags}},Error(`Performance threshold exceeded: ${e.name} = ${e.value}${e.unit}`))}async measureFunction(e,t,r){this.startTimer(e,r);try{let a=await t();return this.endTimer(e,{...r,success:"true"}),a}catch(t){throw this.endTimer(e,{...r,success:"false",error:t.message}),t}}getMetrics(e,t=100){let r=this.metrics;return e&&(r=r.filter(t=>t.name===e)),r.sort((e,t)=>t.timestamp-e.timestamp).slice(0,t)}getMetricStats(e,t=36e5){let r=Date.now(),a=this.metrics.filter(a=>a.name===e&&a.timestamp>r-t);if(0===a.length)return null;let s=a.map(e=>e.value).sort((e,t)=>e-t),n=s.length,i=s[0],o=s[n-1],c=s.reduce((e,t)=>e+t,0)/n,u=s[Math.floor(.5*n)],l=s[Math.floor(.95*n)],d=s[Math.floor(.99*n)];return{count:n,min:i,max:o,avg:c,p50:u,p95:l,p99:d}}initializeObservers(){}getResourceType(e){return e.includes(".js")?"script":e.includes(".css")?"stylesheet":e.includes(".png")||e.includes(".jpg")||e.includes(".jpeg")||e.includes(".gif")||e.includes(".webp")?"image":e.includes(".woff")||e.includes(".ttf")?"font":e.includes("/api/")?"api":"other"}monitorMemory(){}getSummary(){let e=Date.now(),t=this.metrics.filter(t=>t.timestamp>e-3e5),r={},a=[],s=[],n=t.filter(e=>"page_load_time"===e.name);if(n.length>0){let e=n.reduce((e,t)=>e+t.value,0)/n.length;r.avgPageLoadTime=Math.round(e),e>3e3&&(a.push(...n.filter(e=>e.value>3e3)),s.push("Consider optimizing page load performance"))}let i=t.filter(e=>e.name.includes("_duration")&&e.name.includes("api"));if(i.length>0){let e=i.reduce((e,t)=>e+t.value,0)/i.length;r.avgApiTime=Math.round(e),e>1e3&&(a.push(...i.filter(e=>e.value>1e3)),s.push("API calls are slow, consider optimization"))}let o=t.filter(e=>"memory_used"===e.name);if(o.length>0){let e=o[o.length-1];r.currentMemoryUsage=e.value,e.value>50&&(a.push(e),s.push("High memory usage detected"))}let c=t.filter(e=>"long_task_duration"===e.name);return c.length>0&&(r.longTaskCount=c.length,r.maxLongTaskDuration=Math.max(...c.map(e=>e.value)),c.length>5&&s.push("Multiple long tasks detected, consider code optimization")),{metrics:r,alerts:a,recommendations:s}}cleanup(){this.observers.forEach(e=>e.disconnect()),this.observers=[],this.metrics=[],this.entries.clear()}constructor(){this.metrics=[],this.entries=new Map,this.observers=[]}}async function m(e){try{let t=e.headers.get("Authorization");if(!t||!t.startsWith("Bearer "))return null;let a=t.split(" ")[1];if(!a)return null;let{createClient:s}=await Promise.all([r.e(752),r.e(340)]).then(r.bind(r,3340)),n=s(),i=await n.verifyJwt({token:a,domain:"localhost:3000"}),{data:o}=await c.E2.from("admin_fids").select("fid").eq("fid",i.sub.toString()).single();if(!o)return null;return{fid:i.sub.toString()}}catch(e){return console.error("Admin verification failed:",e),null}}function p(e){let t=new Date,r=new Date;switch(e){case"1d":r.setDate(t.getDate()-1);break;case"7d":default:r.setDate(t.getDate()-7);break;case"30d":r.setDate(t.getDate()-30);break;case"90d":r.setDate(t.getDate()-90)}return{startDate:r,endDate:t}}async function g(e){let t=d.getInstance();return await t.measureFunction("api_analytics_get",async()=>{let t=await m(e);if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),a=r.get("action"),s=r.get("period")||"7d";try{switch(a){case"overview":{let[e,t,r,a,s,n]=await Promise.all([c.E2.from("rounds").select("id",{count:"exact"}),c.E2.from("rounds").select("id",{count:"exact"}).eq("status","active"),c.E2.from("guesses").select("id",{count:"exact"}),c.E2.from("user_sessions").select("fid",{count:"exact"}),c.E2.from("rounds").select("prize_pool").eq("status","finished"),f(7)]),i=s.data?.reduce((e,t)=>e+(t.prize_pool||0),0)||0;return o.NextResponse.json({overview:{totalRounds:e.count||0,activeRounds:t.count||0,totalGuesses:r.count||0,totalUsers:a.count||0,totalPrizeAmount:i,recentActivity:n}})}case"performance":{let{startDate:e,endDate:t}=p(s),[r,a,n,i,c]=await Promise.all([h(e,t),y(e,t),w(e,t),_(e,t),R(s)]);return o.NextResponse.json({performance:{period:s,errorRate:r,avgResponseTime:a,uptime:n,apiCalls:i,clientMetrics:c}})}case"user-stats":{let{startDate:e,endDate:t}=p(s),[r,a,n,i]=await Promise.all([v(e,t),x(e,t),S(10),D(s)]);return o.NextResponse.json({userStats:{period:s,newUsers:r,activeUsers:a,topUsers:n,userRetention:i}})}case"round-stats":{let{startDate:e,endDate:t}=p(s),[r,a,n,i]=await Promise.all([M(e,t),E(e,t),I(e,t),j(e,t)]);return o.NextResponse.json({roundStats:{period:s,roundsByStatus:r,averageParticipation:a,prizeDistribution:n,roundDuration:i}})}case"real-time":{let[e,t,r,a]=await Promise.all([u.J.getActiveRound(),T(),b(10),k()]);return o.NextResponse.json({realTime:{currentRound:e,onlineUsers:t,recentGuesses:r,systemHealth:a,timestamp:new Date().toISOString()}})}default:return o.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return(0,l.ow)("Analytics API error",{action:"analytics_get",userId:t.fid,additionalData:{action:a,period:s,error:e.message}},e),o.NextResponse.json({error:"Internal server error",details:e instanceof Error?e.message:"Unknown error"},{status:500})}})}async function f(e){let t=new Date;t.setDate(t.getDate()-e);let{data:r}=await c.E2.from("rounds").select("created_at, status, prize_pool").gte("created_at",t.toISOString()).order("created_at",{ascending:!1}).limit(10);return r||[]}async function h(e,t){return .02}async function y(e,t){return 150}async function w(e,t){return 99.9}async function _(e,t){return 15e3}async function v(e,t){let{count:r}=await c.E2.from("user_sessions").select("fid",{count:"exact"}).gte("created_at",e.toISOString()).lte("created_at",t.toISOString());return r||0}async function x(e,t){let{data:r}=await c.E2.from("guesses").select("user_fid").gte("created_at",e.toISOString()).lte("created_at",t.toISOString());return new Set(r?.map(e=>e.user_fid)||[]).size}async function S(e){let{data:t}=await c.E2.from("guesses").select("user_fid").limit(1e3);return Object.entries(t?.reduce((e,t)=>(e[t.user_fid]=(e[t.user_fid]||0)+1,e),{})||{}).sort(([,e],[,t])=>t-e).slice(0,e).map(([e,t])=>({user_fid:e,count:t}))}async function D(e){return .75}async function M(e,t){let{data:r}=await c.E2.from("rounds").select("status").gte("created_at",e.toISOString()).lte("created_at",t.toISOString());return r?.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{})||{}}async function E(e,t){let{data:r}=await c.E2.from("rounds").select("id").gte("created_at",e.toISOString()).lte("created_at",t.toISOString());return r&&0!==r.length?(await Promise.all(r.map(async e=>{let{count:t}=await c.E2.from("guesses").select("id",{count:"exact"}).eq("round_id",e.id);return t||0}))).reduce((e,t)=>e+t,0)/r.length:0}async function I(e,t){let{data:r}=await c.E2.from("rounds").select("prize_pool").eq("status","finished").gte("created_at",e.toISOString()).lte("created_at",t.toISOString()),a=r?.map(e=>e.prize_pool||0)||[];return{total:a.reduce((e,t)=>e+t,0),average:a.length>0?a.reduce((e,t)=>e+t,0)/a.length:0,min:a.length>0?Math.min(...a):0,max:a.length>0?Math.max(...a):0}}async function j(e,t){return 3600}async function T(){return 25}async function b(e){let{data:t}=await c.E2.from("guesses").select("user_fid, guess_amount, created_at").order("created_at",{ascending:!1}).limit(e);return t||[]}async function k(){return{database:"healthy",api:"healthy",websocket:"healthy",externalApis:{mempool:"healthy",farcaster:"healthy"}}}async function R(e){let t=d.getInstance(),{startDate:r,endDate:a}=p(e),s=a.getTime()-r.getTime(),n=t.getMetricStats("page_load_time",s),i=t.getMetricStats("api_call_duration",s),o=t.getMetricStats("memory_used",s);return{pageLoadTime:n||{count:0,min:0,max:0,avg:0,p50:0,p95:0,p99:0},apiCallTime:i||{count:0,min:0,max:0,avg:0,p50:0,p95:0,p99:0},memoryUsage:o||{count:0,min:0,max:0,avg:0,p50:0,p95:0,p99:0},longTasks:t.getMetricStats("long_task_duration",s)||{count:0,min:0,max:0,avg:0,p50:0,p95:0,p99:0},summary:t.getSummary()}}async function q(e){let t=d.getInstance();return await t.measureFunction("api_analytics_post",async()=>{try{let{metrics:r,events:a}=await e.json();if(r&&Array.isArray(r)&&r.forEach(e=>{t.recordMetric({name:e.name,value:e.value,unit:e.unit||"ms",timestamp:e.timestamp||Date.now(),tags:e.tags||{}})}),a&&Array.isArray(a))for(let e of a){let{error:t}=await c.E2.from("analytics_events").insert({event:e.name,data:e.data,user_fid:e.userId,created_at:new Date(e.timestamp||Date.now()).toISOString()});t&&(0,l.ow)("Failed to record analytics event",{action:"analytics_record",additionalData:{error:t.message,event:e}},Error(t.message))}return t.recordMetric({name:"analytics_api_post",value:1,unit:"count",timestamp:Date.now(),tags:{metricsCount:r?.length||0,eventsCount:a?.length||0}}),o.NextResponse.json({success:!0,message:"Analytics data recorded"})}catch(e){return(0,l.ow)("Failed to record analytics data",{action:"analytics_post",additionalData:{error:e.message}},e),o.NextResponse.json({error:"Failed to record analytics data"},{status:500})}})}let O=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/analytics/route",pathname:"/api/analytics",filename:"route",bundlePath:"app/api/analytics/route"},resolvedPagePath:"c:\\Users\\UserBQ\\Downloads\\mini app\\blocks\\src\\app\\api\\analytics\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:A,workUnitAsyncStorage:P,serverHooks:z}=O;function N(){return(0,i.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:P})}},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3939:e=>{e.exports=require("@supabase/supabase-js")},4573:e=>{e.exports=require("node:buffer")},4708:e=>{e.exports=require("node:https")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7067:e=>{e.exports=require("node:http")},7598:e=>{e.exports=require("node:crypto")},7975:e=>{e.exports=require("node:util")},8474:e=>{e.exports=require("node:events")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[859,176,839],()=>r(2618));module.exports=a})();