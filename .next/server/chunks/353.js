exports.id=353,exports.ids=[353],exports.modules={1203:(e,t,r)=>{"use strict";r.d(t,{LC:()=>o});var s=r(4535),n=r(5521);class a{static getInstance(){return a.instance||(a.instance=new a),a.instance}startTimer(e,t){this.entries.set(e,{name:e,startTime:performance.now(),metadata:t})}endTimer(e,t){let r=this.entries.get(e);if(!r)return console.warn(`Timer '${e}' was not started`),null;let s=performance.now()-r.startTime;return this.recordMetric({name:`${e}_duration`,value:Math.round(s),unit:"ms",timestamp:Date.now(),tags:{...r.metadata,...t}}),this.entries.delete(e),s}recordMetric(e){this.metrics.push(e),this.metrics.length>1e3&&(this.metrics=this.metrics.slice(-1e3)),e.value>("ms"===e.unit?1e3:"percent"===e.unit?90:1e6)&&(0,n.ow)(`High ${e.name} detected`,{action:"performance_alert",additionalData:{metric:e.name,value:e.value,unit:e.unit,tags:e.tags}},Error(`Performance threshold exceeded: ${e.name} = ${e.value}${e.unit}`))}async measureFunction(e,t,r){this.startTimer(e,r);try{let s=await t();return this.endTimer(e,{...r,success:"true"}),s}catch(t){throw this.endTimer(e,{...r,success:"false",error:t.message}),t}}getMetrics(e,t=100){let r=this.metrics;return e&&(r=r.filter(t=>t.name===e)),r.sort((e,t)=>t.timestamp-e.timestamp).slice(0,t)}getMetricStats(e,t=36e5){let r=Date.now(),s=this.metrics.filter(s=>s.name===e&&s.timestamp>r-t);if(0===s.length)return null;let n=s.map(e=>e.value).sort((e,t)=>e-t),a=n.length,o=n[0],i=n[a-1],c=n.reduce((e,t)=>e+t,0)/a,u=n[Math.floor(.5*a)],l=n[Math.floor(.95*a)],d=n[Math.floor(.99*a)];return{count:a,min:o,max:i,avg:c,p50:u,p95:l,p99:d}}initializeObservers(){}getResourceType(e){return e.includes(".js")?"script":e.includes(".css")?"stylesheet":e.includes(".png")||e.includes(".jpg")||e.includes(".jpeg")||e.includes(".gif")||e.includes(".webp")?"image":e.includes(".woff")||e.includes(".ttf")?"font":e.includes("/api/")?"api":"other"}monitorMemory(){}getSummary(){let e=Date.now(),t=this.metrics.filter(t=>t.timestamp>e-3e5),r={},s=[],n=[],a=t.filter(e=>"page_load_time"===e.name);if(a.length>0){let e=a.reduce((e,t)=>e+t.value,0)/a.length;r.avgPageLoadTime=Math.round(e),e>3e3&&(s.push(...a.filter(e=>e.value>3e3)),n.push("Consider optimizing page load performance"))}let o=t.filter(e=>e.name.includes("_duration")&&e.name.includes("api"));if(o.length>0){let e=o.reduce((e,t)=>e+t.value,0)/o.length;r.avgApiTime=Math.round(e),e>1e3&&(s.push(...o.filter(e=>e.value>1e3)),n.push("API calls are slow, consider optimization"))}let i=t.filter(e=>"memory_used"===e.name);if(i.length>0){let e=i[i.length-1];r.currentMemoryUsage=e.value,e.value>50&&(s.push(e),n.push("High memory usage detected"))}let c=t.filter(e=>"long_task_duration"===e.name);return c.length>0&&(r.longTaskCount=c.length,r.maxLongTaskDuration=Math.max(...c.map(e=>e.value)),c.length>5&&n.push("Multiple long tasks detected, consider code optimization")),{metrics:r,alerts:s,recommendations:n}}cleanup(){this.observers.forEach(e=>e.disconnect()),this.observers=[],this.metrics=[],this.entries.clear()}constructor(){this.metrics=[],this.entries=new Map,this.observers=[]}}function o(e){let t=function(){let e=a.getInstance();return{startTimer:e.startTimer.bind(e),endTimer:e.endTimer.bind(e),measureFunction:e.measureFunction.bind(e),recordMetric:e.recordMetric.bind(e),getMetrics:e.getMetrics.bind(e),getMetricStats:e.getMetricStats.bind(e),getSummary:e.getSummary.bind(e),monitorMemory:e.monitorMemory.bind(e)}}();(0,s.useRef)(void 0);let r=(0,s.useRef)(0),o=(0,s.useCallback)((s,a)=>{r.current+=1,t.recordMetric({name:"user_interaction",value:1,unit:"count",timestamp:Date.now(),tags:{component:e,action:s,interactionCount:r.current.toString()}});try{fetch("/api/analytics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:[{name:"user_interaction",data:{component:e,action:s,interactionCount:r.current,...a},timestamp:Date.now()}]})}).catch(t=>{(0,n.ow)("Failed to send interaction analytics",{action:"analytics_send",additionalData:{componentName:e,action:s,error:t.message}},t)})}catch(t){(0,n.ow)("Error tracking user interaction",{action:"interaction_tracking",additionalData:{componentName:e,action:s}},t)}},[e,t]),i=(0,s.useCallback)(async(r,s,n)=>await t.measureFunction(`${e}_${r}`,s,{component:e,operation:r,...n}),[e,t]),c=(0,s.useCallback)(async(r,s,n)=>await t.measureFunction(`api_${r}`,s,{component:e,api:r,...n}),[e,t]);return{trackInteraction:o,trackAsyncOperation:i,trackApiCall:c,trackFormSubmission:(0,s.useCallback)((r,s,a,o)=>{t.recordMetric({name:"form_submission",value:1,unit:"count",timestamp:Date.now(),tags:{component:e,form:r,success:a.toString()}});try{fetch("/api/analytics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:[{name:"form_submission",data:{component:e,form:r,success:a,error:o?.message,fieldCount:Object.keys(s).length},timestamp:Date.now()}]})}).catch(t=>{(0,n.ow)("Failed to send form analytics",{action:"analytics_send",additionalData:{componentName:e,formName:r,error:t.message}},t)})}catch(t){(0,n.ow)("Error tracking form submission",{action:"form_tracking",additionalData:{componentName:e,formName:r}},t)}},[e,t]),trackError:(0,s.useCallback)((r,s)=>{t.recordMetric({name:"component_error",value:1,unit:"count",timestamp:Date.now(),tags:{component:e,errorType:r.constructor.name,errorMessage:r.message}}),(0,n.ow)(`Error in ${e}`,{action:"component_error",additionalData:{componentName:e,context:s,error:r.message}},r)},[e,t])}}},1974:(e,t,r)=>{"use strict";function s(){return null}r.d(t,{default:()=>s}),r(4535)},2612:(e,t,r)=>{Promise.resolve().then(r.t.bind(r,3539,23)),Promise.resolve().then(r.t.bind(r,4191,23)),Promise.resolve().then(r.t.bind(r,8483,23)),Promise.resolve().then(r.t.bind(r,7362,23)),Promise.resolve().then(r.t.bind(r,4950,23)),Promise.resolve().then(r.t.bind(r,4282,23)),Promise.resolve().then(r.t.bind(r,368,23)),Promise.resolve().then(r.t.bind(r,338,23))},2615:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>m,metadata:()=>h});var s=r(9284),n=r(4475),a=r.n(n),o=r(2815),i=r.n(o);r(6958);var c=r(3962),u=r(9210),l=r(5228);let d={version:"next",imageUrl:"https://usdozf7pplhxfvrl.public.blob.vercel-storage.com/thumbnail_cmgifd2dg000204jp98x53ays-p9n6Mjcrk6gppFNpz3AczxHR2Yz5kR",button:{title:"Launch Bitcoin Blocks",action:{type:"launch_frame",name:"Bitcoin Blocks",url:"https://bitcoin-block.vercel.app",splashImageUrl:"https://usdozf7pplhxfvrl.public.blob.vercel-storage.com/farcaster/splash_images/splash_image1.svg",splashBackgroundColor:"#ffffff"}}};function m({children:e}){return(0,s.jsxs)("html",{lang:"en",children:[(0,s.jsx)("head",{children:(0,s.jsx)("meta",{property:"fc:frame",content:JSON.stringify(d)})}),(0,s.jsxs)("body",{className:`${a().variable} ${i().variable} antialiased`,children:[(0,s.jsx)(l.default,{}),(0,s.jsx)(c.GameProvider,{children:(0,s.jsx)(u.default,{children:e})})]})]})}let h={title:"Bitcoin Blocks",description:"Predict Bitcoin transactions & compete! Login, guess, and win by forecasting the next block's transaction count. Real-time updates and leaderboard powered by Supabase. Join the battle!",other:{"fc:frame":JSON.stringify({version:"next",imageUrl:"https://usdozf7pplhxfvrl.public.blob.vercel-storage.com/thumbnail_cmgifd2dg000204jp98x53ays-p9n6Mjcrk6gppFNpz3AczxHR2Yz5kR",button:{title:"Launch Bitcoin Blocks",action:{type:"launch_frame",name:"Bitcoin Blocks",url:"https://bitcoin-block.vercel.app",splashImageUrl:"https://usdozf7pplhxfvrl.public.blob.vercel-storage.com/farcaster/splash_images/splash_image1.svg",splashBackgroundColor:"#ffffff"}}})}}},3962:(e,t,r)=>{"use strict";r.d(t,{GameProvider:()=>n});var s=r(2120);(0,s.registerClientReference)(function(){throw Error("Attempted to call DEV_ADDRESSES() from the server but DEV_ADDRESSES is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"c:\\Users\\UserBQ\\Downloads\\mini app\\blocks\\src\\context\\GameContext.tsx","DEV_ADDRESSES"),(0,s.registerClientReference)(function(){throw Error("Attempted to call isDevAddress() from the server but isDevAddress is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"c:\\Users\\UserBQ\\Downloads\\mini app\\blocks\\src\\context\\GameContext.tsx","isDevAddress");let n=(0,s.registerClientReference)(function(){throw Error("Attempted to call GameProvider() from the server but GameProvider is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"c:\\Users\\UserBQ\\Downloads\\mini app\\blocks\\src\\context\\GameContext.tsx","GameProvider");(0,s.registerClientReference)(function(){throw Error("Attempted to call useGame() from the server but useGame is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"c:\\Users\\UserBQ\\Downloads\\mini app\\blocks\\src\\context\\GameContext.tsx","useGame")},4270:(e,t,r)=>{Promise.resolve().then(r.bind(r,1974)),Promise.resolve().then(r.bind(r,5924)),Promise.resolve().then(r.bind(r,8623))},4358:(e,t,r)=>{Promise.resolve().then(r.bind(r,5228)),Promise.resolve().then(r.bind(r,9210)),Promise.resolve().then(r.bind(r,3962))},4820:(e,t,r)=>{Promise.resolve().then(r.t.bind(r,5657,23)),Promise.resolve().then(r.t.bind(r,1697,23)),Promise.resolve().then(r.t.bind(r,9625,23)),Promise.resolve().then(r.t.bind(r,5272,23)),Promise.resolve().then(r.t.bind(r,9608,23)),Promise.resolve().then(r.t.bind(r,7788,23)),Promise.resolve().then(r.t.bind(r,8226,23)),Promise.resolve().then(r.t.bind(r,8380,23))},5228:(e,t,r)=>{"use strict";r.d(t,{default:()=>s});let s=(0,r(2120).registerClientReference)(function(){throw Error("Attempted to call the default export of \"c:\\\\Users\\\\UserBQ\\\\Downloads\\\\mini app\\\\blocks\\\\src\\\\components\\\\FarcasterMetaOverride.tsx\" from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"c:\\Users\\UserBQ\\Downloads\\mini app\\blocks\\src\\components\\FarcasterMetaOverride.tsx","default")},5521:(e,t,r)=>{"use strict";r.d(t,{ow:()=>o,sY:()=>a}),r(4535);class s{constructor(){this.errors=[],this.maxErrors=100,this.shouldLogToConsole=!1,this.shouldLogToService="true"===process.env.NEXT_PUBLIC_ERROR_LOGGING}static getInstance(){return s.instance||(s.instance=new s),s.instance}generateErrorId(){return`err_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getContext(){return{timestamp:Date.now()}}handleGlobalError(e){this.logError(e.message||"Unknown error","system","high",{...this.getContext(),component:"global",additionalData:{filename:e.filename,lineno:e.lineno,colno:e.colno}},e.error)}handleUnhandledRejection(e){this.logError("Unhandled promise rejection","system","high",{...this.getContext(),component:"promise",additionalData:{reason:e.reason}},e.reason)}logError(e,t,r,s={},n){let a=this.generateErrorId(),o={id:a,message:e,category:t,severity:r,context:{timestamp:Date.now(),...this.getContext(),...s},stack:n instanceof Error?n.stack:void 0,originalError:n};this.errors.push(o),this.errors.length>this.maxErrors&&(this.errors=this.errors.slice(-this.maxErrors)),this.shouldLogToConsole&&this.logErrorToConsole(o),this.shouldLogToService&&this.sendToErrorService(o).catch(e=>{console.error("Failed to send error to logging service:",e)});try{let e=JSON.parse(localStorage.getItem("error_logs")||"[]");e.push(o),e.length>50&&e.splice(0,e.length-50),localStorage.setItem("error_logs",JSON.stringify(e))}catch(e){console.warn("Failed to store error in localStorage:",e)}return a}logErrorToConsole(e){let{severity:t,message:r,category:s,context:n,stack:a}=e,o=this.getSeverityEmoji(t);console.group(`${o} [${t.toUpperCase()}] ${s}: ${r}`),console.log("Context:",n),a&&console.log("Stack trace:",a),console.groupEnd()}getSeverityEmoji(e){switch(e){case"low":return"\uD83D\uDFE1";case"medium":return"\uD83D\uDFE0";case"high":return"\uD83D\uDD34";case"critical":return"\uD83D\uDC80";default:return"⚪"}}async sendToErrorService(e){try{let t=await fetch("/api/errors",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error(`HTTP ${t.status}: ${t.statusText}`)}catch(e){console.error("Failed to send error to service:",e)}}getErrors(e){return e?this.errors.slice(-e):[...this.errors]}clearErrors(){this.errors=[]}getErrorStats(){let e={low:0,medium:0,high:0,critical:0};return this.errors.forEach(t=>{e[t.severity]++}),e}}let n=s.getInstance(),a=(e,t,r)=>n.logError(e,"database","high",t,r),o=(e,t,r)=>n.logError(e,"system","medium",t,r)},5850:(e,t,r)=>{"use strict";r.d(t,{aC:()=>o,fD:()=>a});var s=r(6003);class n{static getInstance(){return n.instance||(n.instance=new n),n.instance}async initializeAuth(){return this.authPromise||(this.authPromise=this.performAuthInitialization()),this.authPromise}async performAuthInitialization(){try{console.log("\uD83D\uDD10 Initializing enhanced Farcaster authentication...");let e=this.getCachedUser();if(e&&!this.isSessionExpired(e))return console.log("✅ Using cached user session"),this.currentUser=e,this.startSessionRefresh(),this.validateSessionWithSupabase(e).catch(e=>{console.warn("⚠️ Background session validation failed:",e)}),e;let{sdk:t}=await r.e(678).then(r.bind(r,2678)),s=0;for(;s<5;)try{let e=5e3*Math.pow(2,s);await Promise.race([t.actions.ready(),new Promise((t,r)=>setTimeout(()=>r(Error("SDK initialization timeout")),e))]),console.log("✅ Farcaster SDK initialized successfully");break}catch(a){let e=++s>=5;if(console.warn(`⚠️ SDK initialization attempt ${s}/5 failed:`,a),e)throw Error(`Failed to initialize Farcaster SDK after 5 attempts. Last error: ${a}`);let t=1e3*s,r=1e3*Math.random(),n=Math.min(t+r,1e4);await new Promise(e=>setTimeout(e,n))}let n=await Promise.race([this.getUserContextWithValidation(t),new Promise((e,t)=>setTimeout(()=>t(Error("User context timeout after 10 seconds")),1e4))]);if(console.log("\uD83D\uDCCB Enhanced Farcaster context retrieved:",n),!n?.user)throw Error("No user context available from Farcaster SDK");let a=n.user.fid;if(!a||"number"!=typeof a||a<=0)throw Error("Invalid FID received from Farcaster SDK");let o=n.user.username||`user-${a}`,i=n.user.displayName||o,c=this.validateAndSanitizePfpUrl(n.user.pfpUrl||""),u=await this.checkIsAdminWithFallback(a),l={address:`fid-${a}`,username:this.sanitizeUsername(o),displayName:this.sanitizeDisplayName(i),pfpUrl:c,isAdmin:u,createdAt:Date.now(),lastActive:Date.now()};return this.cacheUserWithMetadata(l),await this.storeUserSessionWithRetry(a,l),this.startSessionRefresh(),this.currentUser=l,console.log("✅ Enhanced user authentication successful:",l),l}catch(e){return console.error("❌ Enhanced authentication failed:",e),this.currentUser=null,this.cleanup(),null}finally{this.authPromise=null}}async getUserContextWithValidation(e){try{let t=await e.context;if(!t||"object"!=typeof t)throw Error("Invalid context structure received");if(!t.user||"object"!=typeof t.user)throw Error("Invalid user object in context");let{user:r}=t;if(!r.fid)throw Error("Missing FID in user context");return t}catch(e){throw console.error("❌ Error retrieving user context:",e),e}}validateAndSanitizePfpUrl(e){if(!e||"string"!=typeof e)return"";try{let t=new URL(e);if("https:"!==t.protocol)return console.warn("⚠️ Insecure PFP URL protocol detected, using empty URL"),"";let r=t.hostname;if(!["vercel.app","supabase.co","farcaster.xyz","warpcast.com","ipfs.io","cloudflare-ipfs.com"].some(e=>r.includes(e)))return console.warn("⚠️ Untrusted PFP URL domain detected, using empty URL"),"";return e}catch(e){return console.warn("⚠️ Invalid PFP URL format, using empty URL:",e),""}}sanitizeUsername(e){return e&&"string"==typeof e&&e.replace(/[<>\"'&]/g,"").replace(/\s+/g,"_").substring(0,50).trim()||"unknown"}sanitizeDisplayName(e){return e&&"string"==typeof e&&e.replace(/[<>\"'&]/g,"").substring(0,100).trim()||"Unknown User"}async checkIsAdminWithFallback(e){try{if(await this.checkIsAdmin(e))return console.log(`✅ User ${e} confirmed as admin via database`),!0;if([250704,1107084].includes(e))return console.log(`⚠️ User ${e} is admin via fallback list, updating database...`),this.addAdminToFallbackList(e).catch(e=>{console.warn("⚠️ Failed to update admin database:",e)}),!0;return!1}catch(e){return console.error("❌ Error checking admin status:",e),!1}}async addAdminToFallbackList(e){try{let{error:t}=await s.E2.from("admin_fids").upsert({fid:e.toString(),permissions:{role:"admin",permissions:["all"],source:"fallback"},created_at:Date.now(),updated_at:Date.now()},{onConflict:"fid"});if(t)throw t;console.log(`✅ Admin ${e} added to database from fallback list`)}catch(e){throw console.error("❌ Failed to add admin to database:",e),e}}async checkIsAdmin(e){try{let{data:t,error:r}=await Promise.race([s.ND.from("admin_fids").select("fid, permissions").eq("fid",e.toString()).single(),new Promise((e,t)=>setTimeout(()=>t(Error("Admin check timeout")),5e3))]);if(r){if("code"in r&&"PGRST116"===r.code)return!1;return console.warn("⚠️ Error checking admin status:",r),!1}if(t&&t.permissions){let e="string"==typeof t.permissions?JSON.parse(t.permissions):t.permissions;return"admin"===e.role||e.permissions?.includes("all")}return!!t}catch(e){return console.error("❌ Error checking admin status:",e),!1}}async storeUserSessionWithRetry(e,t){let r=0;for(;r<3;)try{await this.storeUserSession(e,t);return}catch(s){let e=++r>=3;if(console.warn(`⚠️ User session storage attempt ${r}/3 failed:`,s),e)return void console.error("❌ Failed to store user session after all retries:",s);let t=1e3*Math.pow(2,r-1);await new Promise(e=>setTimeout(e,t))}}async storeUserSession(e,t){try{let r={fid:e.toString(),session_data:{...t,sessionId:this.generateSessionId(),deviceInfo:this.getDeviceInfo(),lastUpdated:Date.now()},created_at:Date.now(),expires_at:Date.now()+this.SESSION_TIMEOUT},{error:n}=await s.E2.from("user_sessions").upsert(r,{onConflict:"fid"});if(n)throw Error(`Database error: ${n.message}`);console.log("✅ User session stored successfully")}catch(e){throw console.error("❌ Error storing user session:",e),e}}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,15)}`}getDeviceInfo(){try{return{userAgent:navigator.userAgent.substring(0,500),language:navigator.language||"unknown",platform:navigator.platform||"unknown",timestamp:new Date().toISOString()}}catch(e){return console.warn("⚠️ Error getting device info:",e),{userAgent:"unknown",language:"unknown",platform:"unknown",timestamp:new Date().toISOString()}}}cacheUserWithMetadata(e){try{let t={user:e,timestamp:Date.now(),version:"1.0",checksum:this.generateUserChecksum(e)};localStorage.setItem("bitcoin-blocks-user",JSON.stringify(t)),sessionStorage.setItem("bitcoin-blocks-user-backup",JSON.stringify(t))}catch(e){console.warn("⚠️ Error caching user with metadata:",e)}}generateUserChecksum(e){return btoa(`${e.address}-${e.username}-${e.isAdmin}-${e.lastActive}`).substring(0,16)}getCachedUser(){try{let e=localStorage.getItem("bitcoin-blocks-user");if(e||(e=sessionStorage.getItem("bitcoin-blocks-user-backup")),!e)return null;let t=JSON.parse(e);if(!t.user||!t.timestamp||!t.checksum)return console.warn("⚠️ Invalid cache structure detected"),this.clearCache(),null;let r=this.generateUserChecksum(t.user);if(t.checksum!==r)return console.warn("⚠️ Cache checksum mismatch, possible tampering"),this.clearCache(),null;return t.user}catch(e){return console.warn("⚠️ Error getting cached user:",e),this.clearCache(),null}}clearCache(){try{localStorage.removeItem("bitcoin-blocks-user"),sessionStorage.removeItem("bitcoin-blocks-user-backup")}catch(e){console.warn("⚠️ Error clearing cache:",e)}}isSessionExpired(e){return!e.lastActive||Date.now()-e.lastActive>this.SESSION_TIMEOUT}startSessionRefresh(){this.sessionRefreshInterval&&clearInterval(this.sessionRefreshInterval),this.sessionRefreshInterval=setInterval(async()=>{if(this.currentUser)try{await this.refreshSession()}catch(e){console.error("❌ Error in session refresh:",e)}},this.REFRESH_INTERVAL)}async validateSessionWithSupabase(e){try{let t=e.address.replace("fid-",""),{data:r,error:n}=await s.ND.from("user_sessions").select("expires_at").eq("fid",t).single();if(n)throw Error(`Session validation failed: ${n.message}`);r&&Date.now()>r.expires_at&&(console.warn("⚠️ Session expired on server, clearing local cache"),this.signOut())}catch(e){console.warn("⚠️ Session validation error:",e)}}cleanup(){this.sessionRefreshInterval&&(clearInterval(this.sessionRefreshInterval),this.sessionRefreshInterval=null)}getCurrentUser(){return this.currentUser?this.isSessionExpired(this.currentUser)?(console.warn("⚠️ Current user session expired"),this.signOut(),null):this.currentUser:null}async signOut(){try{this.cleanup(),this.clearCache(),this.currentUser=null,this.authPromise=null,await s.ND.auth.signOut().catch(e=>{console.warn("⚠️ Error signing out from Supabase:",e)}),console.log("✅ User signed out successfully")}catch(e){console.error("❌ Error signing out:",e)}}async refreshSession(){if(!this.currentUser)return null;try{let e=Date.now();this.currentUser.lastActive=e,this.cacheUserWithMetadata(this.currentUser);let t=parseInt(this.currentUser.address.replace("fid-",""));return this.storeUserSession(t,this.currentUser).catch(e=>{console.warn("⚠️ Failed to update session in background:",e)}),this.currentUser}catch(e){return console.error("❌ Error refreshing session:",e),null}}async updateProfile(e){if(!this.currentUser)return null;try{let t=this.validateProfileUpdates(e),r={...this.currentUser,...t,lastActive:Date.now()};this.cacheUserWithMetadata(r);let s=parseInt(this.currentUser.address.replace("fid-",""));return await this.storeUserSession(s,r),this.currentUser=r,console.log("✅ User profile updated successfully"),r}catch(e){return console.error("❌ Error updating user profile:",e),null}}validateProfileUpdates(e){let t={};return void 0!==e.username&&(t.username=this.sanitizeUsername(e.username)),void 0!==e.displayName&&(t.displayName=this.sanitizeDisplayName(e.displayName)),void 0!==e.pfpUrl&&(t.pfpUrl=this.validateAndSanitizePfpUrl(e.pfpUrl)),t}constructor(){this.currentUser=null,this.authPromise=null,this.sessionRefreshInterval=null,this.SESSION_TIMEOUT=864e5,this.REFRESH_INTERVAL=18e5}}let a=n.getInstance();async function o(e){if(!e)return void await s.ND.rpc("reset_config");let t=e.address.replace("fid-",""),{error:r}=await s.ND.rpc("set_config",{key:"app.current_fid",value:t});r?console.warn("⚠️ Error setting Supabase context:",r):console.log("✅ Supabase context set for user:",t)}},5924:(e,t,r)=>{"use strict";r.d(t,{default:()=>o});var s=r(2966),n=r(4535),a=r(8623);function o({children:e}){let{user:t,setUser:r}=(0,a.Im)(),[o,i]=(0,n.useState)(!0);return o?(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"}),(0,s.jsx)("p",{className:"text-white text-lg",children:"Initializing Farcaster..."})]})}):(0,s.jsx)(s.Fragment,{children:e})}r(5850)},6003:(e,t,r)=>{"use strict";r.d(t,{E2:()=>a,ND:()=>n,nh:()=>u,vE:()=>i});var s=r(3939);console.log("\uD83D\uDD0D DEBUG - Supabase Client Initialization:",{runtime:"server",nodeEnv:"production",nextRuntime:"nodejs",supabaseUrl:"configured",hasAnonKey:!0,timestamp:new Date().toISOString()});let n=(0,s.createClient)("https://masgfwpxfytraiwkvbmg.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hc2dmd3B4Znl0cmFpd2t2Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTQ5NTYsImV4cCI6MjA3NjI3MDk1Nn0.QAVE2pVMR869KycgzXe2MaQyJTyQb-yZM5zfIbtsMDM",{db:{schema:"public"},realtime:{params:{eventsPerSecond:10,reconnectDelay:2e3,maxReconnectAttempts:10,heartbeatIntervalMs:3e4,wsCloseTimeout:5e3}},auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!1,debug:!1,flowType:"pkce"},global:{headers:{"x-application-name":"bitcoin-blocks-miniapp","x-application-version":"1.0.0","x-client-type":"web","x-content-type-options":"nosniff","x-frame-options":"DENY","x-xss-protection":"1; mode=block"}}}),a=(0,s.createClient)("https://masgfwpxfytraiwkvbmg.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1,debug:!1},db:{schema:"public"},global:{headers:{"x-application-name":"bitcoin-blocks-miniapp-admin","x-application-version":"1.0.0","x-client-type":"admin","x-privilege-level":"service-role"}}});async function o(){try{let{data:e,error:t}=await n.from("rounds").select("id").limit(1).single();if(t&&"PGRST116"!==t.code)return console.warn("⚠️ Supabase connection check failed:",t),!1;return!0}catch(e){return console.error("❌ Supabase connection check error:",e),!1}}async function i(e,t=3,r=1e3){let s;for(let n=1;n<=t;n++)try{return await e()}catch(a){if(s=a,n===t)throw console.error(`❌ Supabase operation failed after ${t} attempts:`,a),s;let e=r*Math.pow(2,n-1);console.warn(`⚠️ Supabase operation attempt ${n}/${t} failed, retrying in ${e}ms:`,a),await new Promise(t=>setTimeout(t,e))}throw s}class c{static getInstance(){return c.instance||(c.instance=new c),c.instance}startMonitoring(){this.checkInterval||(this.checkConnection(),this.checkInterval=setInterval(()=>{this.checkConnection()},this.CHECK_INTERVAL))}stopMonitoring(){this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null)}async checkConnection(){let e=await o();e!==this.isConnected&&(this.isConnected=e,this.notifyListeners(e),e?console.log("✅ Supabase connection restored"):console.warn("⚠️ Supabase connection lost"))}notifyListeners(e){this.listeners.forEach(t=>{try{t(e)}catch(e){console.error("❌ Error in connection listener:",e)}})}addListener(e){this.listeners.push(e)}removeListener(e){let t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}getConnectionStatus(){return this.isConnected}constructor(){this.isConnected=!1,this.checkInterval=null,this.CHECK_INTERVAL=3e4,this.listeners=[]}}let u=c.getInstance()},6958:()=>{},8623:(e,t,r)=>{"use strict";r.d(t,{GameProvider:()=>g,gD:()=>h,Im:()=>p});var s=r(2966),n=r(4535),a=r(5850),o=r(6003),i=r(5521);class c{static getInstance(){return c.instance||(c.instance=new c),c.instance}async retryQuery(e,t=3,r=1e3){let s=null;for(let n=1;n<=t;n++)try{let a=await Promise.race([e(),new Promise((e,t)=>setTimeout(()=>t(Error("Query timeout")),this.queryTimeout))]);if(a.error&&(s=a.error,n<t)){await new Promise(e=>setTimeout(e,r*n));continue}return a}catch(e){s=e,n<t&&await new Promise(e=>setTimeout(e,r*n))}return{data:null,error:s}}async batchQuery(e){try{return await Promise.allSettled(e.map(e=>this.retryQuery(e))).then(e=>e.map(e=>"fulfilled"===e.status?e.value:{data:null,error:e.reason}))}catch(t){return await (0,i.ow)("Batch query failed",{action:"batch_query",additionalData:{queryCount:e.length}},t),e.map(()=>({data:null,error:t}))}}async getRounds(e=50,t){try{let{data:r,error:s}=await this.retryQuery(async()=>{let r=o.ND.from("rounds").select("*").order("created_at",{ascending:!1}).limit(e);return t&&(r=r.eq("status",t)),await r});if(s)return await (0,i.ow)("Error fetching rounds",{action:"fetch_rounds",additionalData:{limit:e,status:t}},s),[];return this.transformRounds(r||[])}catch(r){return await (0,i.ow)("Unexpected error fetching rounds",{action:"fetch_rounds_unexpected",additionalData:{limit:e,status:t}},r),[]}}async getActiveRound(){try{let{data:e,error:t}=await this.retryQuery(async()=>o.ND.from("rounds").select("*").eq("status","open").single());if(t&&"PGRST116"!==t.code)return await (0,i.ow)("Error fetching active round",{action:"fetch_active_round"},t),null;return e?this.transformRound(e):null}catch(e){return await (0,i.ow)("Unexpected error fetching active round",{action:"fetch_active_round_unexpected"},e),null}}async getRoundsPaginated(e=1,t=20,r){try{let s=(e-1)*t,[n,a]=await Promise.all([this.retryQuery(async()=>{let e=o.ND.from("rounds").select("*").order("created_at",{ascending:!1}).range(s,s+t-1);return r&&(e=e.eq("status",r)),await e}),this.retryQuery(async()=>{let e=o.ND.from("rounds").select("*",{count:"exact",head:!0});return r&&(e=e.eq("status",r)),await e})]);n.error&&await (0,i.ow)("Error fetching paginated rounds",{action:"fetch_rounds_paginated",additionalData:{page:e,limit:t,status:r}},n.error);let c=a.data?.count||0,u=s+t<c;return{rounds:this.transformRounds(n.data||[]),totalCount:c,hasMore:u}}catch(s){return await (0,i.ow)("Unexpected error fetching paginated rounds",{action:"fetch_rounds_paginated_unexpected",additionalData:{page:e,limit:t,status:r}},s),{rounds:[],totalCount:0,hasMore:!1}}}async getRoundsWithStats(e=10){try{let{data:t,error:r}=await this.retryQuery(async()=>o.ND.from("rounds").select(`
            *,
            guesses(count)
          `).order("created_at",{ascending:!1}).limit(e));if(r)return await (0,i.ow)("Error fetching rounds with stats",{action:"fetch_rounds_stats"},r),[];return(t||[]).map(e=>({...this.transformRound(e),participationCount:e.guesses?.[0]?.count||0,averageGuess:0}))}catch(e){return await (0,i.ow)("Unexpected error fetching rounds with stats",{action:"fetch_rounds_stats_unexpected"},e),[]}}async createRound(e){try{let t=Date.now(),{data:r,error:s}=await o.E2.from("rounds").insert({round_number:e.roundNumber,start_time:e.startTime,end_time:e.endTime,prize:e.prize,status:"open",block_number:e.blockNumber,created_at:t,duration:e.duration}).select().single();if(s)return console.error("❌ Error creating round:",s),null;let n=this.transformRound(r);return console.log("✅ Round created successfully:",n),await this.logAction("round_created",`Round #${e.roundNumber} created`,{roundId:n.id,roundNumber:e.roundNumber,prize:e.prize}),n}catch(e){return console.error("❌ Unexpected error creating round:",e),null}}async updateRound(e,t){try{let{data:r,error:s}=await o.E2.from("rounds").update(this.transformRoundToDb(t)).eq("id",e).select().single();if(s)return console.error("❌ Error updating round:",s),null;let n=this.transformRound(r);return console.log("✅ Round updated successfully:",n),n}catch(e){return console.error("❌ Unexpected error updating round:",e),null}}async endRound(e){try{let{error:t}=await o.E2.from("rounds").update({status:"closed"}).eq("id",e);if(t)return console.error("❌ Error ending round:",t),!1;return console.log("✅ Round ended successfully:",e),await this.logAction("round_ended",`Round ${e} ended`,{roundId:e}),!0}catch(e){return console.error("❌ Unexpected error ending round:",e),!1}}async updateRoundResult(e,t,r,s){try{let{error:n}=await o.E2.from("rounds").update({status:"finished",actual_tx_count:t,block_hash:r,winning_fid:s}).eq("id",e);if(n)return console.error("❌ Error updating round result:",n),!1;return console.log("✅ Round result updated successfully:",e),await this.logAction("round_finished",`Round ${e} finished`,{roundId:e,actualTxCount:t,blockHash:r,winningFid:s}),!0}catch(e){return console.error("❌ Unexpected error updating round result:",e),!1}}async getGuessesForRound(e){try{let{data:t,error:r}=await o.ND.from("guesses").select("*").eq("round_id",e).order("created_at",{ascending:!0});if(r)return console.error("❌ Error fetching guesses for round:",r),[];return this.transformGuesses(t||[])}catch(e){return console.error("❌ Unexpected error fetching guesses for round:",e),[]}}async submitGuess(e){try{let t=Date.now(),{data:r,error:s}=await o.ND.from("guesses").insert({round_id:e.roundId,user_fid:e.userFid,guess_amount:e.guessAmount,created_at:t,username:e.username,pfp_url:e.pfpUrl}).select().single();if(s)return console.error("❌ Error submitting guess:",s),null;let n=this.transformGuess(r);return console.log("✅ Guess submitted successfully:",n),await this.logAction("guess_submitted",`${e.username} predicted ${e.guessAmount} transactions`,{roundId:e.roundId,userFid:e.userFid,guessAmount:e.guessAmount}),n}catch(e){return console.error("❌ Unexpected error submitting guess:",e),null}}async hasUserGuessed(e,t){try{let{data:r,error:s}=await o.ND.from("guesses").select("id").eq("round_id",e).eq("user_fid",t).single();if(s&&"PGRST116"!==s.code)return console.error("❌ Error checking if user guessed:",s),!1;return!!r}catch(e){return console.error("❌ Unexpected error checking if user guessed:",e),!1}}async getChatMessages(e=100){try{let{data:t,error:r}=await o.ND.from("chat_messages").select("*").order("created_at",{ascending:!1}).limit(e);if(r)return console.error("❌ Error fetching chat messages:",r),[];return this.transformChatMessages(t||[])}catch(e){return console.error("❌ Unexpected error fetching chat messages:",e),[]}}async addChatMessage(e){try{let t=Date.now(),{data:r,error:s}=await o.ND.from("chat_messages").insert({user_fid:e.userFid,username:e.username,message:e.message,type:e.type,created_at:t,round_id:e.roundId,pfp_url:e.pfpUrl}).select().single();if(s)return console.error("❌ Error adding chat message:",s),null;let n=this.transformChatMessage(r);return console.log("✅ Chat message added successfully:",n),n}catch(e){return console.error("❌ Unexpected error adding chat message:",e),null}}async getPrizeConfiguration(){try{let{data:e,error:t}=await o.ND.from("prize_configs").select("*").order("version",{ascending:!1}).limit(1).single();if(t&&"PGRST116"!==t.code)return console.error("❌ Error fetching prize configuration:",t),null;return e?this.transformPrizeConfig(e):null}catch(e){return console.error("❌ Unexpected error fetching prize configuration:",e),null}}async updatePrizeConfiguration(e){try{let t=Date.now(),{data:r}=await o.ND.from("prize_configs").select("version").order("version",{ascending:!1}).limit(1).single(),s=(r?.version||0)+1,{data:n,error:a}=await o.E2.from("prize_configs").insert({config_data:e,updated_at:t,version:s}).select().single();if(a)return console.error("❌ Error updating prize configuration:",a),null;let i=this.transformPrizeConfig(n);return console.log("✅ Prize configuration updated successfully:",i),await this.logAction("prize_config_updated","Prize configuration updated",e),i}catch(e){return console.error("❌ Unexpected error updating prize configuration:",e),null}}async getLogs(e=100){try{let{data:t,error:r}=await o.E2.from("audit_logs").select("*").order("created_at",{ascending:!1}).limit(e);if(r)return console.error("❌ Error fetching logs:",r),[];return this.transformLogs(t||[])}catch(e){return console.error("❌ Unexpected error fetching logs:",e),[]}}async getLeaderboard(e,t=50){try{if(e){let{data:r,error:s}=await this.retryQuery(async()=>o.ND.from("guesses").select(`
              user_fid,
              username,
              pfp_url,
              guess_amount,
              created_at,
              rounds!inner(actual_tx_count)
            `).eq("round_id",e).not("rounds.actual_tx_count","is",null).order("guess_amount",{ascending:!1}).limit(t));if(s)return await (0,i.ow)("Error fetching round leaderboard",{action:"fetch_leaderboard_round",additionalData:{roundId:e,limit:t}},s),[];let n=r||[],a=n[0]?.rounds?.[0]?.actual_tx_count||0;return n.map((e,t)=>({rank:t+1,userFid:e.user_fid,username:e.username,pfpUrl:e.pfp_url,totalPoints:100*(0===Math.abs(e.guess_amount-a)),correctGuesses:+(0===Math.abs(e.guess_amount-a)),totalParticipation:1,winRate:100*(0===Math.abs(e.guess_amount-a))}))}{let{data:e,error:r}=await this.retryQuery(async()=>o.ND.from("guesses").select(`
              user_fid,
              username,
              pfp_url,
              guess_amount,
              created_at,
              rounds!inner(actual_tx_count, status)
            `).eq("rounds.status","finished").not("rounds.actual_tx_count","is",null).order("created_at",{ascending:!1}));if(r)return await (0,i.ow)("Error fetching overall leaderboard",{action:"fetch_leaderboard_overall",additionalData:{limit:t}},r),[];let s=new Map;return(e||[]).forEach(e=>{let t=e.user_fid,r=0===Math.abs(e.guess_amount-(e.rounds?.[0]?.actual_tx_count||0));s.has(t)||s.set(t,{userFid:t,username:e.username,pfpUrl:e.pfp_url,totalPoints:0,correctGuesses:0,totalParticipation:0});let n=s.get(t);n.totalParticipation++,r&&(n.correctGuesses++,n.totalPoints+=100)}),Array.from(s.values()).map(e=>({...e,winRate:e.totalParticipation>0?Math.round(e.correctGuesses/e.totalParticipation*100):0})).sort((e,t)=>t.totalPoints-e.totalPoints||t.correctGuesses-e.correctGuesses).slice(0,t).map((e,t)=>({...e,rank:t+1}))}}catch(r){return await (0,i.ow)("Unexpected error fetching leaderboard",{action:"fetch_leaderboard_unexpected",additionalData:{roundId:e,limit:t}},r),[]}}async getUserStats(e){try{let{data:t,error:r}=await this.retryQuery(async()=>o.ND.from("guesses").select(`
            guess_amount,
            created_at,
            round_id,
            rounds!inner(actual_tx_count, status)
          `).eq("user_fid",e).eq("rounds.status","finished").not("rounds.actual_tx_count","is",null).order("created_at",{ascending:!1}));if(r)return await (0,i.ow)("Error fetching user stats",{action:"fetch_user_stats",additionalData:{userFid:e}},r),{totalRounds:0,correctGuesses:0,totalWins:0,averageGuess:0,bestGuess:0,recentActivity:[]};let s=t||[],n=s.filter(e=>0===Math.abs(e.guess_amount-(e.rounds?.[0]?.actual_tx_count||0))),a=s.slice(0,10).map(e=>({roundId:e.round_id,guess:e.guess_amount,actual:e.rounds?.[0]?.actual_tx_count||0,isCorrect:0===Math.abs(e.guess_amount-(e.rounds?.[0]?.actual_tx_count||0))}));return{totalRounds:s.length,correctGuesses:n.length,totalWins:n.length,averageGuess:s.length>0?Math.round(s.reduce((e,t)=>e+t.guess_amount,0)/s.length):0,bestGuess:Math.min(...s.map(e=>Math.abs(e.guess_amount-(e.rounds?.[0]?.actual_tx_count||0)))),recentActivity:a}}catch(t){return await (0,i.ow)("Unexpected error fetching user stats",{action:"fetch_user_stats_unexpected",additionalData:{userFid:e}},t),{totalRounds:0,correctGuesses:0,totalWins:0,averageGuess:0,bestGuess:0,recentActivity:[]}}}async getGameStats(){try{let[e,t,r,s]=await Promise.all([this.retryQuery(async()=>await o.ND.from("rounds").select("*",{count:"exact",head:!0})),this.retryQuery(async()=>await o.ND.from("rounds").select("*",{count:"exact",head:!0}).eq("status","open")),this.retryQuery(async()=>await o.ND.from("guesses").select("*",{count:"exact",head:!0})),this.retryQuery(async()=>await o.ND.from("guesses").select("user_fid",{count:"exact",head:!0}))]),n=e.data?.count||0,a=t.data?.count||0,i=r.data?.count||0,c=s.data?.count||0;return{totalRounds:n,activeRounds:a,totalGuesses:i,totalUsers:c,averageParticipation:n>0?Math.round(i/n):0}}catch(e){return await (0,i.ow)("Unexpected error fetching game stats",{action:"fetch_game_stats_unexpected"},e),{totalRounds:0,activeRounds:0,totalGuesses:0,totalUsers:0,averageParticipation:0}}}async logAction(e,t,r){try{let{error:s}=await o.E2.from("audit_logs").insert({admin_fid:"system",action:e,details:{message:t,...r},created_at:Date.now()});s&&console.warn("⚠️ Error logging action:",s)}catch(e){console.warn("⚠️ Unexpected error logging action:",e)}}subscribeToRounds(e){let t=o.ND.channel("rounds_changes").on("postgres_changes",{event:"*",schema:"public",table:"rounds"},t=>{("INSERT"===t.eventType||"UPDATE"===t.eventType)&&e(this.transformRound(t.new))}).subscribe();return()=>{o.ND.removeChannel(t)}}subscribeToGuesses(e){let t=o.ND.channel("guesses_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},t=>{e(this.transformGuess(t.new))}).subscribe();return()=>{o.ND.removeChannel(t)}}subscribeToChatMessages(e){let t=o.ND.channel("chat_messages_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages"},t=>{e(this.transformChatMessage(t.new))}).subscribe();return()=>{o.ND.removeChannel(t)}}subscribeToPrizeConfigs(e){let t=o.ND.channel("prize_configs_changes").on("postgres_changes",{event:"*",schema:"public",table:"prize_configs"},t=>{("INSERT"===t.eventType||"UPDATE"===t.eventType)&&e(this.transformPrizeConfig(t.new))}).subscribe();return()=>{o.ND.removeChannel(t)}}transformRounds(e){return e.map(e=>this.transformRound(e))}transformRound(e){return{id:e.id,roundNumber:e.round_number,startTime:e.start_time,endTime:e.end_time,prize:e.prize,status:e.status,blockNumber:e.block_number,actualTxCount:e.actual_tx_count,winningAddress:e.winning_fid,blockHash:e.block_hash,createdAt:e.created_at,duration:e.duration}}transformRoundToDb(e){let t={};return void 0!==e.roundNumber&&(t.round_number=e.roundNumber),void 0!==e.startTime&&(t.start_time=e.startTime),void 0!==e.endTime&&(t.end_time=e.endTime),void 0!==e.prize&&(t.prize=e.prize),void 0!==e.status&&(t.status=e.status),void 0!==e.blockNumber&&(t.block_number=e.blockNumber),void 0!==e.actualTxCount&&(t.actual_tx_count=e.actualTxCount),void 0!==e.winningAddress&&(t.winning_fid=e.winningAddress),void 0!==e.blockHash&&(t.block_hash=e.blockHash),void 0!==e.createdAt&&(t.created_at=e.createdAt),void 0!==e.duration&&(t.duration=e.duration),t}transformGuesses(e){return e.map(e=>this.transformGuess(e))}transformGuess(e){return{id:e.id,roundId:e.round_id,address:e.user_fid,username:e.username,guess:e.guess_amount,pfpUrl:e.pfp_url,submittedAt:e.created_at}}transformChatMessages(e){return e.map(e=>this.transformChatMessage(e))}transformChatMessage(e){return{id:e.id,roundId:e.round_id,address:e.user_fid,username:e.username,message:e.message,pfpUrl:e.pfp_url,timestamp:e.created_at,type:e.type}}transformPrizeConfig(e){return{id:e.id,jackpotAmount:e.config_data.jackpotAmount,firstPlaceAmount:e.config_data.firstPlaceAmount,secondPlaceAmount:e.config_data.secondPlaceAmount,currencyType:e.config_data.currencyType,tokenContractAddress:e.config_data.tokenContractAddress,updatedAt:e.updated_at}}transformLogs(e){return e.map(e=>this.transformLog(e))}transformLog(e){return{id:e.id,eventType:e.action,details:e.details.message||e.details,timestamp:e.created_at}}constructor(){this.queryTimeout=1e4}}let u=c.getInstance();var l=r(1203);let d=(0,n.createContext)(void 0),m=["fid-250704","fid-1107084"];function h(e){return m.some(t=>t.toLowerCase()===e.toLowerCase())}function g({children:e}){let{trackInteraction:t,trackAsyncOperation:r,trackApiCall:c,trackError:m}=(0,l.LC)("GameContext"),[h,g]=(0,n.useState)(null),[p,f]=(0,n.useState)([]),[y,w]=(0,n.useState)([]),[b,v]=(0,n.useState)([]),[_,S]=(0,n.useState)([]),[E,C]=(0,n.useState)(null),[U,x]=(0,n.useState)(!1),[k,D]=(0,n.useState)({rounds:!1,guesses:!1,chatMessages:!1,prizeConfig:!1,auth:!1,connection:!1}),[A,P]=(0,n.useState)({rounds:null,guesses:null,chatMessages:null,prizeConfig:null,auth:null,connection:null}),[I,R]=(0,n.useState)({lastSyncTime:Date.now(),syncCount:0,errorCount:0,getConnectionHealth:()=>o.nh.getConnectionStatus()}),T=(0,n.useRef)({guesses:new Map,chatMessages:new Map,rounds:new Map}),M=p.find(e=>"open"===e.status)||null,N={addGuessOptimistically:e=>{T.current.guesses.set(e.id,e),w(t=>t.find(t=>t.id===e.id)?t:[e,...t])},addChatMessageOptimistically:e=>{T.current.chatMessages.set(e.id,e),S(t=>t.find(t=>t.id===e.id)?t:[e,...t].slice(0,100))},updateRoundOptimistically:(e,t)=>{T.current.rounds.set(e,t),f(r=>r.map(r=>r.id===e?{...r,...t}:r))}},z={retryLoadRounds:async()=>{D(e=>({...e,rounds:!0})),P(e=>({...e,rounds:null}));try{await (0,o.vE)(async()=>{let e=await u.getRounds();f(e),R(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1}))})}catch(e){P(t=>({...t,rounds:e instanceof Error?e.message:"Failed to load rounds"})),R(e=>({...e,errorCount:e.errorCount+1}))}finally{D(e=>({...e,rounds:!1}))}},retryLoadChatMessages:async()=>{D(e=>({...e,chatMessages:!0})),P(e=>({...e,chatMessages:null}));try{await (0,o.vE)(async()=>{let e=await u.getChatMessages(100);S(e),R(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1}))})}catch(e){P(t=>({...t,chatMessages:e instanceof Error?e.message:"Failed to load chat messages"})),R(e=>({...e,errorCount:e.errorCount+1}))}finally{D(e=>({...e,chatMessages:!1}))}},retryConnection:async()=>{D(e=>({...e,connection:!0})),P(e=>({...e,connection:null}));try{let e=await (0,o.vE)(async()=>{let e=o.nh.getConnectionStatus();if("boolean"!=typeof e)throw Error("Invalid connection status");return e});x(e),e&&await Promise.all([z.retryLoadRounds(),z.retryLoadChatMessages()])}catch(e){x(!1),P(t=>({...t,connection:e instanceof Error?e.message:"Connection failed"})),R(e=>({...e,errorCount:e.errorCount+1}))}finally{D(e=>({...e,connection:!1}))}}},F=(0,n.useCallback)(async(e,t,r,s,n,a)=>{if(console.log(`🎮 [SUPABASE] createRound called`,{roundNumber:e,startTime:t,endTime:r,prize:s,blockNumber:n,duration:a,connected:U}),!U){let e="Not connected to database";throw console.error("❌",e),Error(e)}try{if(console.log(`📤 [SUPABASE] Creating round...`,{roundNumber:e,duration:a,prize:s,blockNumber:n}),!await u.createRound({roundNumber:e,startTime:t,endTime:r,prize:s,blockNumber:n,duration:a}))throw Error("Failed to create round");console.log(`✅ [SUPABASE] Round created successfully!`)}catch(e){throw console.error(`❌ [SUPABASE] Failed to create round:`,e),e}},[U]),G=(0,n.useCallback)(async(e,s,n,a,l)=>await r("submitGuess",async()=>{if(!U)return console.warn(`⚠️ [SUPABASE] Not connected`),!1;let r=p.find(t=>t.id===e);if(!r||"open"!==r.status)return console.warn(`⚠️ [SUPABASE] Round not open:`,{roundId:e,status:r?.status}),!1;if(Date.now()>=r.endTime)return console.warn(`⚠️ [SUPABASE] Round time expired`),!1;if(y.some(t=>t.roundId===e&&t.address.toLowerCase()===s.toLowerCase()))return console.warn(`⚠️ [SUPABASE] User already guessed`),!1;try{let r=s.replace("fid-",""),i={id:`temp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,roundId:e,address:s,username:n,guess:a,pfpUrl:l,submittedAt:Date.now()};if(N.addGuessOptimistically(i),!await c("submitGuess",()=>(0,o.vE)(async()=>u.submitGuess({roundId:e,userFid:r,username:n,guessAmount:a,pfpUrl:l}))))return w(e=>e.filter(e=>e.id!==i.id)),console.error(`❌ [SUPABASE] Failed to submit guess`),P(e=>({...e,guesses:"Failed to submit prediction. Please try again."})),R(e=>({...e,errorCount:e.errorCount+1})),!1;return console.log(`✅ [SUPABASE] Guess submitted with optimistic update!`),R(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1})),t("submitGuess",{roundId:e,guessAmount:a,success:!0}),!0}catch(r){let t=r instanceof Error?r.message:"Failed to submit prediction";return console.error(`❌ [SUPABASE] Failed to submit guess:`,r),m(r,{action:"submitGuess",roundId:e,guessAmount:a}),(0,i.sY)(t,{component:"GameContext",action:"submitGuess",additionalData:{roundId:e,userFid:s.replace("fid-",""),guessAmount:a}},r),P(e=>({...e,guesses:t})),R(e=>({...e,errorCount:e.errorCount+1})),!1}}),[U,p,y,r,c,t,m]),B=(0,n.useCallback)(async e=>{if(!U)return console.warn(`⚠️ [SUPABASE] Not connected`),!1;let t=p.find(t=>t.id===e);if(!t||"open"!==t.status)return console.warn(`⚠️ [SUPABASE] Round not open:`,{roundId:e,status:t?.status}),!1;try{if(!await u.endRound(e))return console.error(`❌ [SUPABASE] Failed to end round`),!1;return console.log(`✅ [SUPABASE] Round ended!`),!0}catch(e){return console.error(`❌ [SUPABASE] Failed to end round:`,e),!1}},[U,p]),L=(0,n.useCallback)(async(e,t,r,s)=>{if(!U)throw Error("Not connected to database");try{if(!await u.updateRoundResult(e,t,r,s))throw Error("Failed to update round result");console.log(`✅ [SUPABASE] Round result updated!`)}catch(e){throw console.error(`❌ [SUPABASE] Failed to update round result:`,e),e}},[U]),$=(0,n.useCallback)(e=>y.filter(t=>t.roundId===e),[y]),O=(0,n.useCallback)((e,t)=>y.some(r=>r.roundId===e&&r.address.toLowerCase()===t.toLowerCase()),[y]),j=(0,n.useCallback)(async e=>await r("addChatMessage",async()=>{if(console.log(`💬 [SUPABASE] Enhanced addChatMessage called`,{message:e,connected:U}),!U){let e="Not connected to database";throw console.warn(`⚠️ [SUPABASE]`,e),P(t=>({...t,chatMessages:e})),Error(e)}try{console.log(`📤 [SUPABASE] Sending enhanced chat message...`);let r=e.address.replace("fid-",""),s={...e,id:`temp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now()};if(N.addChatMessageOptimistically(s),!await c("addChatMessage",()=>(0,o.vE)(async()=>u.addChatMessage({userFid:r,username:e.username,message:e.message,type:e.type,roundId:e.roundId,pfpUrl:e.pfpUrl}))))throw S(e=>e.filter(e=>e.id!==s.id)),Error("Failed to send chat message");console.log(`✅ [SUPABASE] Enhanced chat message sent with optimistic update!`),R(e=>({...e,lastSyncTime:Date.now(),syncCount:e.syncCount+1})),t("addChatMessage",{messageType:e.type,messageLength:e.message.length,success:!0})}catch(r){let t=r instanceof Error?r.message:"Failed to send message";throw console.error(`❌ [SUPABASE] Failed to send chat message:`,r),m(r,{action:"addChatMessage",messageType:e.type,messageLength:e.message.length}),(0,i.sY)(t,{component:"GameContext",action:"addChatMessage",additionalData:{messageType:e.type,userFid:e.address.replace("fid-","")}},r),P(e=>({...e,chatMessages:t})),R(e=>({...e,errorCount:e.errorCount+1})),r}}),[U,r,c,t,m]),Q=(0,n.useCallback)(async e=>{g(e),await (0,a.aC)(e)},[]);return(0,s.jsx)(d.Provider,{value:{user:h,setUser:Q,rounds:p,guesses:y,logs:b,chatMessages:_,activeRound:M,prizeConfig:E,createRound:F,submitGuess:G,endRound:B,updateRoundResult:L,getGuessesForRound:$,hasUserGuessed:O,addChatMessage:j,connected:U,client:u,mode:"supabase",loadingStates:k,errorStates:A,optimisticActions:N,performance:I,retryActions:z},children:e})}function p(){let e=(0,n.useContext)(d);if(void 0===e)throw Error("useGame must be used within a GameProvider");return e}},9210:(e,t,r)=>{"use strict";r.d(t,{default:()=>s});let s=(0,r(2120).registerClientReference)(function(){throw Error("Attempted to call the default export of \"c:\\\\Users\\\\UserBQ\\\\Downloads\\\\mini app\\\\blocks\\\\src\\\\components\\\\FarcasterWrapper.tsx\" from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"c:\\Users\\UserBQ\\Downloads\\mini app\\blocks\\src\\components\\FarcasterWrapper.tsx","default")}};